"use strict";var vn=Object.create;var it=Object.defineProperty;var yn=Object.getOwnPropertyDescriptor;var En=Object.getOwnPropertyNames;var Nn=Object.getPrototypeOf,_n=Object.prototype.hasOwnProperty;var Sn=(Q,o)=>()=>(o||Q((o={exports:{}}).exports,o),o.exports),Mn=(Q,o)=>{for(var i in o)it(Q,i,{get:o[i],enumerable:!0})},_r=(Q,o,i,a)=>{if(o&&typeof o=="object"||typeof o=="function")for(let u of En(o))!_n.call(Q,u)&&u!==i&&it(Q,u,{get:()=>o[u],enumerable:!(a=yn(o,u))||a.enumerable});return Q};var Dn=(Q,o,i)=>(i=Q!=null?vn(Nn(Q)):{},_r(o||!Q||!Q.__esModule?it(i,"default",{value:Q,enumerable:!0}):i,Q)),kn=Q=>_r(it({},"__esModule",{value:!0}),Q);var Sr=Sn((pt,$e)=>{var ct=void 0,ht=function(Q){return ct||(ct=new Promise(function(o,i){var a=typeof Q<"u"?Q:{},u=a.onAbort;a.onAbort=function(e){i(new Error(e)),u&&u(e)},a.postRun=a.postRun||[],a.postRun.push(function(){o(a)}),$e=void 0;var n;n||=typeof a<"u"?a:{};var d=typeof window=="object",p=typeof WorkerGlobalScope<"u",f=typeof process=="object"&&typeof process.versions=="object"&&typeof process.versions.node=="string"&&process.type!="renderer";n.onRuntimeInitialized=function(){function e(c,b){switch(typeof b){case"boolean":bn(c,b?1:0);break;case"number":fn(c,b);break;case"string":gn(c,b,-1,-1);break;case"object":if(b===null)vr(c);else if(b.length!=null){var L=rt(b,tt);mn(c,L,b.length,-1),nt(L)}else st(c,"Wrong API use : tried to return a value of an unknown type ("+b+").",-1);break;default:vr(c)}}function t(c,b){for(var L=[],q=0;q<c;q+=1){var W=ge(b+4*q,"i32"),Y=un(W);if(Y===1||Y===2)W=dn(W);else if(Y===3)W=hn(W);else if(Y===4){Y=W,W=cn(Y),Y=pn(Y);for(var ve=new Uint8Array(W),we=0;we<W;we+=1)ve[we]=x[Y+we];W=ve}else W=null;L.push(W)}return L}function r(c,b){this.Qa=c,this.db=b,this.Oa=1,this.lb=[]}function s(c,b){if(this.db=b,b=Pe(c)+1,this.eb=$t(b),this.eb===null)throw Error("Unable to allocate memory for the SQL string");Ne(c,M,this.eb,b),this.kb=this.eb,this.Za=this.pb=null}function l(c){if(this.filename="dbfile_"+(4294967295*Math.random()>>>0),c!=null){var b=this.filename,L="/",q=b;if(L&&(L=typeof L=="string"?L:_t(L),q=b?yt(L+"/"+b):L),b=Ut(!0,!0),q=Br(q,b),c){if(typeof c=="string"){L=Array(c.length);for(var W=0,Y=c.length;W<Y;++W)L[W]=c.charCodeAt(W);c=L}Je(q,b|146),L=Be(q,577),ur(L,c,0,c.length,0),Lt(L),Je(q,b)}}this.handleError(A(this.filename,h)),this.db=ge(h,"i32"),Er(this.db),this.fb={},this.Sa={}}var h=xe(4),g=n.cwrap,A=g("sqlite3_open","number",["string","number"]),X=g("sqlite3_close_v2","number",["number"]),z=g("sqlite3_exec","number",["number","string","number","number","number"]),oe=g("sqlite3_changes","number",["number"]),fe=g("sqlite3_prepare_v2","number",["number","string","number","number","number"]),fr=g("sqlite3_sql","string",["number"]),zr=g("sqlite3_normalized_sql","string",["number"]),gr=g("sqlite3_prepare_v2","number",["number","number","number","number","number"]),Ur=g("sqlite3_bind_text","number",["number","number","number","number","number"]),mr=g("sqlite3_bind_blob","number",["number","number","number","number","number"]),Gr=g("sqlite3_bind_double","number",["number","number","number"]),Xr=g("sqlite3_bind_int","number",["number","number","number"]),Qr=g("sqlite3_bind_parameter_index","number",["number","string"]),Kr=g("sqlite3_step","number",["number"]),Jr=g("sqlite3_errmsg","string",["number"]),Yr=g("sqlite3_column_count","number",["number"]),Zr=g("sqlite3_data_count","number",["number"]),en=g("sqlite3_column_double","number",["number","number"]),br=g("sqlite3_column_text","string",["number","number"]),tn=g("sqlite3_column_blob","number",["number","number"]),rn=g("sqlite3_column_bytes","number",["number","number"]),nn=g("sqlite3_column_type","number",["number","number"]),sn=g("sqlite3_column_name","string",["number","number"]),on=g("sqlite3_reset","number",["number"]),an=g("sqlite3_clear_bindings","number",["number"]),ln=g("sqlite3_finalize","number",["number"]),wr=g("sqlite3_create_function_v2","number","number string number number number number number number number".split(" ")),un=g("sqlite3_value_type","number",["number"]),cn=g("sqlite3_value_bytes","number",["number"]),hn=g("sqlite3_value_text","string",["number"]),pn=g("sqlite3_value_blob","number",["number"]),dn=g("sqlite3_value_double","number",["number"]),fn=g("sqlite3_result_double","",["number","number"]),vr=g("sqlite3_result_null","",["number"]),gn=g("sqlite3_result_text","",["number","string","number","number"]),mn=g("sqlite3_result_blob","",["number","number","number","number"]),bn=g("sqlite3_result_int","",["number","number"]),st=g("sqlite3_result_error","",["number","string","number"]),yr=g("sqlite3_aggregate_context","number",["number","number"]),Er=g("RegisterExtensionFunctions","number",["number"]),Nr=g("sqlite3_update_hook","number",["number","number","number"]);r.prototype.bind=function(c){if(!this.Qa)throw"Statement closed";return this.reset(),Array.isArray(c)?this.Cb(c):c!=null&&typeof c=="object"?this.Db(c):!0},r.prototype.step=function(){if(!this.Qa)throw"Statement closed";this.Oa=1;var c=Kr(this.Qa);switch(c){case 100:return!0;case 101:return!1;default:throw this.db.handleError(c)}},r.prototype.wb=function(c){return c==null&&(c=this.Oa,this.Oa+=1),en(this.Qa,c)},r.prototype.Gb=function(c){if(c==null&&(c=this.Oa,this.Oa+=1),c=br(this.Qa,c),typeof BigInt!="function")throw Error("BigInt is not supported");return BigInt(c)},r.prototype.Hb=function(c){return c==null&&(c=this.Oa,this.Oa+=1),br(this.Qa,c)},r.prototype.getBlob=function(c){c==null&&(c=this.Oa,this.Oa+=1);var b=rn(this.Qa,c);c=tn(this.Qa,c);for(var L=new Uint8Array(b),q=0;q<b;q+=1)L[q]=x[c+q];return L},r.prototype.get=function(c,b){b=b||{},c!=null&&this.bind(c)&&this.step(),c=[];for(var L=Zr(this.Qa),q=0;q<L;q+=1)switch(nn(this.Qa,q)){case 1:var W=b.useBigInt?this.Gb(q):this.wb(q);c.push(W);break;case 2:c.push(this.wb(q));break;case 3:c.push(this.Hb(q));break;case 4:c.push(this.getBlob(q));break;default:c.push(null)}return c},r.prototype.getColumnNames=function(){for(var c=[],b=Yr(this.Qa),L=0;L<b;L+=1)c.push(sn(this.Qa,L));return c},r.prototype.getAsObject=function(c,b){c=this.get(c,b),b=this.getColumnNames();for(var L={},q=0;q<b.length;q+=1)L[b[q]]=c[q];return L},r.prototype.getSQL=function(){return fr(this.Qa)},r.prototype.getNormalizedSQL=function(){return zr(this.Qa)},r.prototype.run=function(c){return c!=null&&this.bind(c),this.step(),this.reset()},r.prototype.sb=function(c,b){b==null&&(b=this.Oa,this.Oa+=1),c=Wt(c);var L=rt(c,tt);this.lb.push(L),this.db.handleError(Ur(this.Qa,b,L,c.length-1,0))},r.prototype.Bb=function(c,b){b==null&&(b=this.Oa,this.Oa+=1);var L=rt(c,tt);this.lb.push(L),this.db.handleError(mr(this.Qa,b,L,c.length,0))},r.prototype.rb=function(c,b){b==null&&(b=this.Oa,this.Oa+=1),this.db.handleError((c===(c|0)?Xr:Gr)(this.Qa,b,c))},r.prototype.Eb=function(c){c==null&&(c=this.Oa,this.Oa+=1),mr(this.Qa,c,0,0,0)},r.prototype.tb=function(c,b){switch(b==null&&(b=this.Oa,this.Oa+=1),typeof c){case"string":this.sb(c,b);return;case"number":this.rb(c,b);return;case"bigint":this.sb(c.toString(),b);return;case"boolean":this.rb(c+0,b);return;case"object":if(c===null){this.Eb(b);return}if(c.length!=null){this.Bb(c,b);return}}throw"Wrong API use : tried to bind a value of an unknown type ("+c+")."},r.prototype.Db=function(c){var b=this;return Object.keys(c).forEach(function(L){var q=Qr(b.Qa,L);q!==0&&b.tb(c[L],q)}),!0},r.prototype.Cb=function(c){for(var b=0;b<c.length;b+=1)this.tb(c[b],b+1);return!0},r.prototype.reset=function(){return this.freemem(),an(this.Qa)===0&&on(this.Qa)===0},r.prototype.freemem=function(){for(var c;(c=this.lb.pop())!==void 0;)nt(c)},r.prototype.free=function(){this.freemem();var c=ln(this.Qa)===0;return delete this.db.fb[this.Qa],this.Qa=0,c},s.prototype.next=function(){if(this.eb===null)return{done:!0};if(this.Za!==null&&(this.Za.free(),this.Za=null),!this.db.db)throw this.mb(),Error("Database closed");var c=Ue(),b=xe(4);Fe(h),Fe(b);try{this.db.handleError(gr(this.db.db,this.kb,-1,h,b)),this.kb=ge(b,"i32");var L=ge(h,"i32");return L===0?(this.mb(),{done:!0}):(this.Za=new r(L,this.db),this.db.fb[L]=this.Za,{value:this.Za,done:!1})}catch(q){throw this.pb=vt(this.kb),this.mb(),q}finally{ze(c)}},s.prototype.mb=function(){nt(this.eb),this.eb=null},s.prototype.getRemainingSQL=function(){return this.pb!==null?this.pb:vt(this.kb)},typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"&&(s.prototype[Symbol.iterator]=function(){return this}),l.prototype.run=function(c,b){if(!this.db)throw"Database closed";if(b){c=this.prepare(c,b);try{c.step()}finally{c.free()}}else this.handleError(z(this.db,c,0,0,h));return this},l.prototype.exec=function(c,b,L){if(!this.db)throw"Database closed";var q=Ue(),W=null;try{var Y=Tt(c),ve=xe(4);for(c=[];ge(Y,"i8")!==0;){Fe(h),Fe(ve),this.handleError(gr(this.db,Y,-1,h,ve));var we=ge(h,"i32");if(Y=ge(ve,"i32"),we!==0){var me=null;for(W=new r(we,this),b!=null&&W.bind(b);W.step();)me===null&&(me={columns:W.getColumnNames(),values:[]},c.push(me)),me.values.push(W.get(null,L));W.free()}}return c}catch(ye){throw W&&W.free(),ye}finally{ze(q)}},l.prototype.each=function(c,b,L,q,W){typeof b=="function"&&(q=L,L=b,b=void 0),c=this.prepare(c,b);try{for(;c.step();)L(c.getAsObject(null,W))}finally{c.free()}if(typeof q=="function")return q()},l.prototype.prepare=function(c,b){if(Fe(h),this.handleError(fe(this.db,c,-1,h,0)),c=ge(h,"i32"),c===0)throw"Nothing to prepare";var L=new r(c,this);return b!=null&&L.bind(b),this.fb[c]=L},l.prototype.iterateStatements=function(c){return new s(c,this)},l.prototype.export=function(){Object.values(this.fb).forEach(function(b){b.free()}),Object.values(this.Sa).forEach(ke),this.Sa={},this.handleError(X(this.db));var c=Or(this.filename);return this.handleError(A(this.filename,h)),this.db=ge(h,"i32"),Er(this.db),c},l.prototype.close=function(){this.db!==null&&(Object.values(this.fb).forEach(function(c){c.free()}),Object.values(this.Sa).forEach(ke),this.Sa={},this.Ya&&(ke(this.Ya),this.Ya=void 0),this.handleError(X(this.db)),sr("/"+this.filename),this.db=null)},l.prototype.handleError=function(c){if(c===0)return null;throw c=Jr(this.db),Error(c)},l.prototype.getRowsModified=function(){return oe(this.db)},l.prototype.create_function=function(c,b){Object.prototype.hasOwnProperty.call(this.Sa,c)&&(ke(this.Sa[c]),delete this.Sa[c]);var L=je(function(q,W,Y){W=t(W,Y);try{var ve=b.apply(null,W)}catch(we){st(q,we,-1);return}e(q,ve)},"viii");return this.Sa[c]=L,this.handleError(wr(this.db,c,b.length,1,0,L,0,0,0)),this},l.prototype.create_aggregate=function(c,b){var L=b.init||function(){return null},q=b.finalize||function(me){return me},W=b.step;if(!W)throw"An aggregate function must have a step function in "+c;var Y={};Object.hasOwnProperty.call(this.Sa,c)&&(ke(this.Sa[c]),delete this.Sa[c]),b=c+"__finalize",Object.hasOwnProperty.call(this.Sa,b)&&(ke(this.Sa[b]),delete this.Sa[b]);var ve=je(function(me,ye,It){var Re=yr(me,1);Object.hasOwnProperty.call(Y,Re)||(Y[Re]=L()),ye=t(ye,It),ye=[Y[Re]].concat(ye);try{Y[Re]=W.apply(null,ye)}catch(wn){delete Y[Re],st(me,wn,-1)}},"viii"),we=je(function(me){var ye=yr(me,1);try{var It=q(Y[ye])}catch(Re){delete Y[ye],st(me,Re,-1);return}e(me,It),delete Y[ye]},"vi");return this.Sa[c]=ve,this.Sa[b]=we,this.handleError(wr(this.db,c,W.length-1,1,0,0,ve,we,0)),this},l.prototype.updateHook=function(c){this.Ya&&(Nr(this.db,0,0),ke(this.Ya),this.Ya=void 0),c&&(this.Ya=je(function(b,L,q,W,Y){switch(L){case 18:b="insert";break;case 23:b="update";break;case 9:b="delete";break;default:throw"unknown operationCode in updateHook callback: "+L}if(q=q?ie(M,q):"",W=W?ie(M,W):"",Y>Number.MAX_SAFE_INTEGER)throw"rowId too big to fit inside a Number";c(b,q,W,Number(Y))},"viiiij"),Nr(this.db,this.Ya,0))},n.Database=l};var m={...n},v="./this.program",w=(e,t)=>{throw t},D="",_,E;if(f){var S=require("fs");require("path"),D=__dirname+"/",E=e=>(e=ee(e)?new URL(e):e,S.readFileSync(e)),_=async e=>(e=ee(e)?new URL(e):e,S.readFileSync(e,void 0)),!n.thisProgram&&1<process.argv.length&&(v=process.argv[1].replace(/\\/g,"/")),process.argv.slice(2),typeof $e<"u"&&($e.exports=n),w=(e,t)=>{throw process.exitCode=e,t}}else(d||p)&&(p?D=self.location.href:typeof document<"u"&&document.currentScript&&(D=document.currentScript.src),D=D.startsWith("blob:")?"":D.slice(0,D.replace(/[?#].*/,"").lastIndexOf("/")+1),p&&(E=e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),_=async e=>{if(ee(e))return new Promise((r,s)=>{var l=new XMLHttpRequest;l.open("GET",e,!0),l.responseType="arraybuffer",l.onload=()=>{l.status==200||l.status==0&&l.response?r(l.response):s(l.status)},l.onerror=s,l.send(null)});var t=await fetch(e,{credentials:"same-origin"});if(t.ok)return t.arrayBuffer();throw Error(t.status+" : "+t.url)});var H=n.print||console.log.bind(console),y=n.printErr||console.error.bind(console);Object.assign(n,m),m=null,n.thisProgram&&(v=n.thisProgram);var C=n.wasmBinary,R,B=!1,k,x,M,Z,$,I,le,F,G,ee=e=>e.startsWith("file://");function V(){var e=R.buffer;n.HEAP8=x=new Int8Array(e),n.HEAP16=Z=new Int16Array(e),n.HEAPU8=M=new Uint8Array(e),n.HEAPU16=new Uint16Array(e),n.HEAP32=$=new Int32Array(e),n.HEAPU32=I=new Uint32Array(e),n.HEAPF32=le=new Float32Array(e),n.HEAPF64=G=new Float64Array(e),n.HEAP64=F=new BigInt64Array(e),n.HEAPU64=new BigUint64Array(e)}var K=0,U=null;function P(e){var t;throw(t=n.onAbort)==null||t.call(n,e),e="Aborted("+e+")",y(e),B=!0,new WebAssembly.RuntimeError(e+". Build with -sASSERTIONS for more info.")}var O;async function J(e){if(!C)try{var t=await _(e);return new Uint8Array(t)}catch{}if(e==O&&C)e=new Uint8Array(C);else if(E)e=E(e);else throw"both async and sync fetching of the wasm failed";return e}async function ne(e,t){try{var r=await J(e);return await WebAssembly.instantiate(r,t)}catch(s){y(`failed to asynchronously prepare wasm: ${s}`),P(s)}}async function he(e){var t=O;if(!C&&typeof WebAssembly.instantiateStreaming=="function"&&!ee(t)&&!f)try{var r=fetch(t,{credentials:"same-origin"});return await WebAssembly.instantiateStreaming(r,e)}catch(s){y(`wasm streaming compile failed: ${s}`),y("falling back to ArrayBuffer instantiation")}return ne(t,e)}class ce{name="ExitStatus";constructor(t){this.message=`Program terminated with exit(${t})`,this.status=t}}var te=e=>{for(;0<e.length;)e.shift()(n)},se=[],ue=[],Ce=()=>{var e=n.preRun.shift();ue.unshift(e)};function ge(e,t="i8"){switch(t.endsWith("*")&&(t="*"),t){case"i1":return x[e];case"i8":return x[e];case"i16":return Z[e>>1];case"i32":return $[e>>2];case"i64":return F[e>>3];case"float":return le[e>>2];case"double":return G[e>>3];case"*":return I[e>>2];default:P(`invalid type for getValue: ${t}`)}}var Se=n.noExitRuntime||!0;function Fe(e){var t="i32";switch(t.endsWith("*")&&(t="*"),t){case"i1":x[e]=0;break;case"i8":x[e]=0;break;case"i16":Z[e>>1]=0;break;case"i32":$[e>>2]=0;break;case"i64":F[e>>3]=BigInt(0);break;case"float":le[e>>2]=0;break;case"double":G[e>>3]=0;break;case"*":I[e>>2]=0;break;default:P(`invalid type for setValue: ${t}`)}}var Ot=typeof TextDecoder<"u"?new TextDecoder:void 0,ie=(e,t=0,r=NaN)=>{var s=t+r;for(r=t;e[r]&&!(r>=s);)++r;if(16<r-t&&e.buffer&&Ot)return Ot.decode(e.subarray(t,r));for(s="";t<r;){var l=e[t++];if(l&128){var h=e[t++]&63;if((l&224)==192)s+=String.fromCharCode((l&31)<<6|h);else{var g=e[t++]&63;l=(l&240)==224?(l&15)<<12|h<<6|g:(l&7)<<18|h<<12|g<<6|e[t++]&63,65536>l?s+=String.fromCharCode(l):(l-=65536,s+=String.fromCharCode(55296|l>>10,56320|l&1023))}}else s+=String.fromCharCode(l)}return s},vt=(e,t)=>e?ie(M,e,t):"",Ft=(e,t)=>{for(var r=0,s=e.length-1;0<=s;s--){var l=e[s];l==="."?e.splice(s,1):l===".."?(e.splice(s,1),r++):r&&(e.splice(s,1),r--)}if(t)for(;r;r--)e.unshift("..");return e},yt=e=>{var t=e.charAt(0)==="/",r=e.slice(-1)==="/";return(e=Ft(e.split("/").filter(s=>!!s),!t).join("/"))||t||(e="."),e&&r&&(e+="/"),(t?"/":"")+e},Pt=e=>{var t=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(e).slice(1);return e=t[0],t=t[1],!e&&!t?".":(t&&=t.slice(0,-1),e+t)},Ge=e=>e&&e.match(/([^\/]+|\/)\/*$/)[1],xr=()=>{if(f){var e=require("crypto");return t=>e.randomFillSync(t)}return t=>crypto.getRandomValues(t)},Vt=e=>{(Vt=xr())(e)},Lr=(...e)=>{for(var t="",r=!1,s=e.length-1;-1<=s&&!r;s--){if(r=0<=s?e[s]:"/",typeof r!="string")throw new TypeError("Arguments to path.resolve must be strings");if(!r)return"";t=r+"/"+t,r=r.charAt(0)==="/"}return t=Ft(t.split("/").filter(l=>!!l),!r).join("/"),(r?"/":"")+t||"."},Et=[],Pe=e=>{for(var t=0,r=0;r<e.length;++r){var s=e.charCodeAt(r);127>=s?t++:2047>=s?t+=2:55296<=s&&57343>=s?(t+=4,++r):t+=3}return t},Ne=(e,t,r,s)=>{if(!(0<s))return 0;var l=r;s=r+s-1;for(var h=0;h<e.length;++h){var g=e.charCodeAt(h);if(55296<=g&&57343>=g){var A=e.charCodeAt(++h);g=65536+((g&1023)<<10)|A&1023}if(127>=g){if(r>=s)break;t[r++]=g}else{if(2047>=g){if(r+1>=s)break;t[r++]=192|g>>6}else{if(65535>=g){if(r+2>=s)break;t[r++]=224|g>>12}else{if(r+3>=s)break;t[r++]=240|g>>18,t[r++]=128|g>>12&63}t[r++]=128|g>>6&63}t[r++]=128|g&63}}return t[r]=0,r-l},Wt=(e,t)=>{var r=Array(Pe(e)+1);return e=Ne(e,r,0,r.length),t&&(r.length=e),r},jt=[];function zt(e,t){jt[e]={input:[],output:[],cb:t},kt(e,Cr)}var Cr={open(e){var t=jt[e.node.rdev];if(!t)throw new N(43);e.tty=t,e.seekable=!1},close(e){e.tty.cb.fsync(e.tty)},fsync(e){e.tty.cb.fsync(e.tty)},read(e,t,r,s){if(!e.tty||!e.tty.cb.xb)throw new N(60);for(var l=0,h=0;h<s;h++){try{var g=e.tty.cb.xb(e.tty)}catch{throw new N(29)}if(g===void 0&&l===0)throw new N(6);if(g==null)break;l++,t[r+h]=g}return l&&(e.node.atime=Date.now()),l},write(e,t,r,s){if(!e.tty||!e.tty.cb.qb)throw new N(60);try{for(var l=0;l<s;l++)e.tty.cb.qb(e.tty,t[r+l])}catch{throw new N(29)}return s&&(e.node.mtime=e.node.ctime=Date.now()),l}},Hr={xb(){e:{if(!Et.length){var e=null;if(f){var t=Buffer.alloc(256),r=0,s=process.stdin.fd;try{r=S.readSync(s,t,0,256)}catch(l){if(l.toString().includes("EOF"))r=0;else throw l}0<r&&(e=t.slice(0,r).toString("utf-8"))}else typeof window<"u"&&typeof window.prompt=="function"&&(e=window.prompt("Input: "),e!==null&&(e+=`
`));if(!e){e=null;break e}Et=Wt(e,!0)}e=Et.shift()}return e},qb(e,t){t===null||t===10?(H(ie(e.output)),e.output=[]):t!=0&&e.output.push(t)},fsync(e){var t;0<((t=e.output)==null?void 0:t.length)&&(H(ie(e.output)),e.output=[])},Tb(){return{Ob:25856,Qb:5,Nb:191,Pb:35387,Mb:[3,28,127,21,4,0,1,0,17,19,26,0,18,15,23,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},Ub(){return 0},Vb(){return[24,80]}},Ar={qb(e,t){t===null||t===10?(y(ie(e.output)),e.output=[]):t!=0&&e.output.push(t)},fsync(e){var t;0<((t=e.output)==null?void 0:t.length)&&(y(ie(e.output)),e.output=[])}},j={Wa:null,Xa(){return j.createNode(null,"/",16895,0)},createNode(e,t,r,s){if((r&61440)===24576||(r&61440)===4096)throw new N(63);return j.Wa||(j.Wa={dir:{node:{Ta:j.La.Ta,Ua:j.La.Ua,lookup:j.La.lookup,hb:j.La.hb,rename:j.La.rename,unlink:j.La.unlink,rmdir:j.La.rmdir,readdir:j.La.readdir,symlink:j.La.symlink},stream:{Va:j.Ma.Va}},file:{node:{Ta:j.La.Ta,Ua:j.La.Ua},stream:{Va:j.Ma.Va,read:j.Ma.read,write:j.Ma.write,ib:j.Ma.ib,jb:j.Ma.jb}},link:{node:{Ta:j.La.Ta,Ua:j.La.Ua,readlink:j.La.readlink},stream:{}},ub:{node:{Ta:j.La.Ta,Ua:j.La.Ua},stream:Ir}}),r=Jt(e,t,r,s),de(r.mode)?(r.La=j.Wa.dir.node,r.Ma=j.Wa.dir.stream,r.Na={}):(r.mode&61440)===32768?(r.La=j.Wa.file.node,r.Ma=j.Wa.file.stream,r.Ra=0,r.Na=null):(r.mode&61440)===40960?(r.La=j.Wa.link.node,r.Ma=j.Wa.link.stream):(r.mode&61440)===8192&&(r.La=j.Wa.ub.node,r.Ma=j.Wa.ub.stream),r.atime=r.mtime=r.ctime=Date.now(),e&&(e.Na[t]=r,e.atime=e.mtime=e.ctime=r.atime),r},Sb(e){return e.Na?e.Na.subarray?e.Na.subarray(0,e.Ra):new Uint8Array(e.Na):new Uint8Array(0)},La:{Ta(e){var t={};return t.dev=(e.mode&61440)===8192?e.id:1,t.ino=e.id,t.mode=e.mode,t.nlink=1,t.uid=0,t.gid=0,t.rdev=e.rdev,de(e.mode)?t.size=4096:(e.mode&61440)===32768?t.size=e.Ra:(e.mode&61440)===40960?t.size=e.link.length:t.size=0,t.atime=new Date(e.atime),t.mtime=new Date(e.mtime),t.ctime=new Date(e.ctime),t.blksize=4096,t.blocks=Math.ceil(t.size/t.blksize),t},Ua(e,t){for(var r of["mode","atime","mtime","ctime"])t[r]!=null&&(e[r]=t[r]);t.size!==void 0&&(t=t.size,e.Ra!=t&&(t==0?(e.Na=null,e.Ra=0):(r=e.Na,e.Na=new Uint8Array(t),r&&e.Na.set(r.subarray(0,Math.min(t,e.Ra))),e.Ra=t)))},lookup(){throw j.vb},hb(e,t,r,s){return j.createNode(e,t,r,s)},rename(e,t,r){try{var s=He(t,r)}catch{}if(s){if(de(e.mode))for(var l in s.Na)throw new N(55);Mt(s)}delete e.parent.Na[e.name],t.Na[r]=e,e.name=r,t.ctime=t.mtime=e.parent.ctime=e.parent.mtime=Date.now()},unlink(e,t){delete e.Na[t],e.ctime=e.mtime=Date.now()},rmdir(e,t){var r=He(e,t),s;for(s in r.Na)throw new N(55);delete e.Na[t],e.ctime=e.mtime=Date.now()},readdir(e){return[".","..",...Object.keys(e.Na)]},symlink(e,t,r){return e=j.createNode(e,t,41471,0),e.link=r,e},readlink(e){if((e.mode&61440)!==40960)throw new N(28);return e.link}},Ma:{read(e,t,r,s,l){var h=e.node.Na;if(l>=e.node.Ra)return 0;if(e=Math.min(e.node.Ra-l,s),8<e&&h.subarray)t.set(h.subarray(l,l+e),r);else for(s=0;s<e;s++)t[r+s]=h[l+s];return e},write(e,t,r,s,l,h){if(t.buffer===x.buffer&&(h=!1),!s)return 0;if(e=e.node,e.mtime=e.ctime=Date.now(),t.subarray&&(!e.Na||e.Na.subarray)){if(h)return e.Na=t.subarray(r,r+s),e.Ra=s;if(e.Ra===0&&l===0)return e.Na=t.slice(r,r+s),e.Ra=s;if(l+s<=e.Ra)return e.Na.set(t.subarray(r,r+s),l),s}h=l+s;var g=e.Na?e.Na.length:0;if(g>=h||(h=Math.max(h,g*(1048576>g?2:1.125)>>>0),g!=0&&(h=Math.max(h,256)),g=e.Na,e.Na=new Uint8Array(h),0<e.Ra&&e.Na.set(g.subarray(0,e.Ra),0)),e.Na.subarray&&t.subarray)e.Na.set(t.subarray(r,r+s),l);else for(h=0;h<s;h++)e.Na[l+h]=t[r+h];return e.Ra=Math.max(e.Ra,l+s),s},Va(e,t,r){if(r===1?t+=e.position:r===2&&(e.node.mode&61440)===32768&&(t+=e.node.Ra),0>t)throw new N(28);return t},ib(e,t,r,s,l){if((e.node.mode&61440)!==32768)throw new N(43);if(e=e.node.Na,l&2||!e||e.buffer!==x.buffer){l=!0,s=65536*Math.ceil(t/65536);var h=pr(65536,s);if(h&&M.fill(0,h,h+s),s=h,!s)throw new N(48);e&&((0<r||r+t<e.length)&&(e.subarray?e=e.subarray(r,r+t):e=Array.prototype.slice.call(e,r,r+t)),x.set(e,s))}else l=!1,s=e.byteOffset;return{Kb:s,Ab:l}},jb(e,t,r,s){return j.Ma.write(e,t,0,s,r,!1),0}}},Ut=(e,t)=>{var r=0;return e&&(r|=365),t&&(r|=146),r},Nt=null,Gt={},qe=[],Tr=1,Me=null,Xt=!1,Qt=!0,Kt={},N=class{name="ErrnoError";constructor(e){this.Pa=e}},Rr=class{gb={};node=null;get flags(){return this.gb.flags}set flags(e){this.gb.flags=e}get position(){return this.gb.position}set position(e){this.gb.position=e}},$r=class{La={};Ma={};ab=null;constructor(e,t,r,s){e||=this,this.parent=e,this.Xa=e.Xa,this.id=Tr++,this.name=t,this.mode=r,this.rdev=s,this.atime=this.mtime=this.ctime=Date.now()}get read(){return(this.mode&365)===365}set read(e){e?this.mode|=365:this.mode&=-366}get write(){return(this.mode&146)===146}set write(e){e?this.mode|=146:this.mode&=-147}};function be(e,t={}){if(!e)throw new N(44);t.nb??(t.nb=!0),e.charAt(0)==="/"||(e="//"+e);var r=0;e:for(;40>r;r++){e=e.split("/").filter(A=>!!A);for(var s=Nt,l="/",h=0;h<e.length;h++){var g=h===e.length-1;if(g&&t.parent)break;if(e[h]!==".")if(e[h]==="..")l=Pt(l),s=s.parent;else{l=yt(l+"/"+e[h]);try{s=He(s,e[h])}catch(A){if((A==null?void 0:A.Pa)===44&&g&&t.Jb)return{path:l};throw A}if(!s.ab||g&&!t.nb||(s=s.ab.root),(s.mode&61440)===40960&&(!g||t.$a)){if(!s.La.readlink)throw new N(52);s=s.La.readlink(s),s.charAt(0)==="/"||(s=Pt(l)+"/"+s),e=s+"/"+e.slice(h+1).join("/");continue e}}}return{path:l,node:s}}throw new N(32)}function _t(e){for(var t;;){if(e===e.parent)return e=e.Xa.zb,t?e[e.length-1]!=="/"?`${e}/${t}`:e+t:e;t=t?`${e.name}/${t}`:e.name,e=e.parent}}function St(e,t){for(var r=0,s=0;s<t.length;s++)r=(r<<5)-r+t.charCodeAt(s)|0;return(e+r>>>0)%Me.length}function Mt(e){var t=St(e.parent.id,e.name);if(Me[t]===e)Me[t]=e.bb;else for(t=Me[t];t;){if(t.bb===e){t.bb=e.bb;break}t=t.bb}}function He(e,t){var r=de(e.mode)?(r=Ie(e,"x"))?r:e.La.lookup?0:2:54;if(r)throw new N(r);for(r=Me[St(e.id,t)];r;r=r.bb){var s=r.name;if(r.parent.id===e.id&&s===t)return r}return e.La.lookup(e,t)}function Jt(e,t,r,s){return e=new $r(e,t,r,s),t=St(e.parent.id,e.name),e.bb=Me[t],Me[t]=e}function de(e){return(e&61440)===16384}function Yt(e){var t=["r","w","rw"][e&3];return e&512&&(t+="w"),t}function Ie(e,t){if(Qt)return 0;if(!t.includes("r")||e.mode&292){if(t.includes("w")&&!(e.mode&146)||t.includes("x")&&!(e.mode&73))return 2}else return 2;return 0}function Zt(e,t){if(!de(e.mode))return 54;try{return He(e,t),20}catch{}return Ie(e,"wx")}function er(e,t,r){try{var s=He(e,t)}catch(l){return l.Pa}if(e=Ie(e,"wx"))return e;if(r){if(!de(s.mode))return 54;if(s===s.parent||_t(s)==="/")return 10}else if(de(s.mode))return 31;return 0}function Xe(e){if(!e)throw new N(63);return e}function pe(e){if(e=qe[e],!e)throw new N(8);return e}function tr(e,t=-1){if(e=Object.assign(new Rr,e),t==-1)e:{for(t=0;4096>=t;t++)if(!qe[t])break e;throw new N(33)}return e.fd=t,qe[t]=e}function qr(e,t=-1){var r,s;return e=tr(e,t),(s=(r=e.Ma)==null?void 0:r.Rb)==null||s.call(r,e),e}function Dt(e,t,r){var s=e==null?void 0:e.Ma.Ua;e=s?e:t,s??=t.La.Ua,Xe(s),s(e,r)}var Ir={open(e){var t,r;e.Ma=Gt[e.node.rdev].Ma,(r=(t=e.Ma).open)==null||r.call(t,e)},Va(){throw new N(70)}};function kt(e,t){Gt[e]={Ma:t}}function rr(e,t){var r=t==="/";if(r&&Nt)throw new N(10);if(!r&&t){var s=be(t,{nb:!1});if(t=s.path,s=s.node,s.ab)throw new N(10);if(!de(s.mode))throw new N(54)}t={type:e,Wb:{},zb:t,Ib:[]},e=e.Xa(t),e.Xa=t,t.root=e,r?Nt=e:s&&(s.ab=t,s.Xa&&s.Xa.Ib.push(t))}function Qe(e,t,r){var s=be(e,{parent:!0}).node;if(e=Ge(e),!e)throw new N(28);if(e==="."||e==="..")throw new N(20);var l=Zt(s,e);if(l)throw new N(l);if(!s.La.hb)throw new N(63);return s.La.hb(s,e,t,r)}function Br(e,t=438){return Qe(e,t&4095|32768,0)}function Ee(e,t=511){return Qe(e,t&1023|16384,0)}function Ke(e,t,r){typeof r>"u"&&(r=t,t=438),Qe(e,t|8192,r)}function xt(e,t){if(!Lr(e))throw new N(44);var r=be(t,{parent:!0}).node;if(!r)throw new N(44);t=Ge(t);var s=Zt(r,t);if(s)throw new N(s);if(!r.La.symlink)throw new N(63);r.La.symlink(r,t,e)}function nr(e){var t=be(e,{parent:!0}).node;e=Ge(e);var r=He(t,e),s=er(t,e,!0);if(s)throw new N(s);if(!t.La.rmdir)throw new N(63);if(r.ab)throw new N(10);t.La.rmdir(t,e),Mt(r)}function sr(e){var t=be(e,{parent:!0}).node;if(!t)throw new N(44);e=Ge(e);var r=He(t,e),s=er(t,e,!1);if(s)throw new N(s);if(!t.La.unlink)throw new N(63);if(r.ab)throw new N(10);t.La.unlink(t,e),Mt(r)}function Ve(e,t){return e=be(e,{$a:!t}).node,Xe(e.La.Ta)(e)}function ir(e,t,r,s){Dt(e,t,{mode:r&4095|t.mode&-4096,ctime:Date.now(),Fb:s})}function Je(e,t){e=typeof e=="string"?be(e,{$a:!0}).node:e,ir(null,e,t)}function or(e,t,r){if(de(t.mode))throw new N(31);if((t.mode&61440)!==32768)throw new N(28);var s=Ie(t,"w");if(s)throw new N(s);Dt(e,t,{size:r,timestamp:Date.now()})}function Be(e,t,r=438){if(e==="")throw new N(44);if(typeof t=="string"){var s={r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090}[t];if(typeof s>"u")throw Error(`Unknown file open mode: ${t}`);t=s}if(r=t&64?r&4095|32768:0,typeof e=="object")s=e;else{var l=e.endsWith("/");e=be(e,{$a:!(t&131072),Jb:!0}),s=e.node,e=e.path}var h=!1;if(t&64)if(s){if(t&128)throw new N(20)}else{if(l)throw new N(31);s=Qe(e,r|511,0),h=!0}if(!s)throw new N(44);if((s.mode&61440)===8192&&(t&=-513),t&65536&&!de(s.mode))throw new N(54);if(!h&&(l=s?(s.mode&61440)===40960?32:de(s.mode)&&(Yt(t)!=="r"||t&576)?31:Ie(s,Yt(t)):44))throw new N(l);return t&512&&!h&&(l=s,l=typeof l=="string"?be(l,{$a:!0}).node:l,or(null,l,0)),t&=-131713,l=tr({node:s,path:_t(s),flags:t,seekable:!0,position:0,Ma:s.Ma,Lb:[],error:!1}),l.Ma.open&&l.Ma.open(l),h&&Je(s,r&511),!n.logReadFiles||t&1||e in Kt||(Kt[e]=1),l}function Lt(e){if(e.fd===null)throw new N(8);e.ob&&(e.ob=null);try{e.Ma.close&&e.Ma.close(e)}catch(t){throw t}finally{qe[e.fd]=null}e.fd=null}function ar(e,t,r){if(e.fd===null)throw new N(8);if(!e.seekable||!e.Ma.Va)throw new N(70);if(r!=0&&r!=1&&r!=2)throw new N(28);e.position=e.Ma.Va(e,t,r),e.Lb=[]}function lr(e,t,r,s,l){if(0>s||0>l)throw new N(28);if(e.fd===null)throw new N(8);if((e.flags&2097155)===1)throw new N(8);if(de(e.node.mode))throw new N(31);if(!e.Ma.read)throw new N(28);var h=typeof l<"u";if(!h)l=e.position;else if(!e.seekable)throw new N(70);return t=e.Ma.read(e,t,r,s,l),h||(e.position+=t),t}function ur(e,t,r,s,l){if(0>s||0>l)throw new N(28);if(e.fd===null)throw new N(8);if(!(e.flags&2097155))throw new N(8);if(de(e.node.mode))throw new N(31);if(!e.Ma.write)throw new N(28);e.seekable&&e.flags&1024&&ar(e,0,2);var h=typeof l<"u";if(!h)l=e.position;else if(!e.seekable)throw new N(70);return t=e.Ma.write(e,t,r,s,l,void 0),h||(e.position+=t),t}function Or(e){var t="binary";if(t!=="utf8"&&t!=="binary")throw Error(`Invalid encoding type "${t}"`);var r,s=Be(e,s||0);e=Ve(e).size;var l=new Uint8Array(e);return lr(s,l,0,e,0),t==="utf8"?r=ie(l):t==="binary"&&(r=l),Lt(s),r}function De(e,t,r){e=yt("/dev/"+e);var s=Ut(!!t,!!r);De.yb??(De.yb=64);var l=De.yb++<<8|0;kt(l,{open(h){h.seekable=!1},close(){var h;(h=r==null?void 0:r.buffer)!=null&&h.length&&r(10)},read(h,g,A,X){for(var z=0,oe=0;oe<X;oe++){try{var fe=t()}catch{throw new N(29)}if(fe===void 0&&z===0)throw new N(6);if(fe==null)break;z++,g[A+oe]=fe}return z&&(h.node.atime=Date.now()),z},write(h,g,A,X){for(var z=0;z<X;z++)try{r(g[A+z])}catch{throw new N(29)}return X&&(h.node.mtime=h.node.ctime=Date.now()),z}}),Ke(e,s,l)}var re={};function Ae(e,t,r){if(t.charAt(0)==="/")return t;if(e=e===-100?"/":pe(e).path,t.length==0){if(!r)throw new N(44);return e}return e+"/"+t}function Ye(e,t){$[e>>2]=t.dev,$[e+4>>2]=t.mode,I[e+8>>2]=t.nlink,$[e+12>>2]=t.uid,$[e+16>>2]=t.gid,$[e+20>>2]=t.rdev,F[e+24>>3]=BigInt(t.size),$[e+32>>2]=4096,$[e+36>>2]=t.blocks;var r=t.atime.getTime(),s=t.mtime.getTime(),l=t.ctime.getTime();return F[e+40>>3]=BigInt(Math.floor(r/1e3)),I[e+48>>2]=r%1e3*1e6,F[e+56>>3]=BigInt(Math.floor(s/1e3)),I[e+64>>2]=s%1e3*1e6,F[e+72>>3]=BigInt(Math.floor(l/1e3)),I[e+80>>2]=l%1e3*1e6,F[e+88>>3]=BigInt(t.ino),0}var Ze=void 0,et=()=>{var e=$[+Ze>>2];return Ze+=4,e},Ct=0,Fr=[0,31,60,91,121,152,182,213,244,274,305,335],Pr=[0,31,59,90,120,151,181,212,243,273,304,334],We={},cr=e=>{var t;k=e,Se||0<Ct||((t=n.onExit)==null||t.call(n,e),B=!0),w(e,new ce(e))},Vr=e=>{if(!B)try{if(e(),!(Se||0<Ct))try{k=e=k,cr(e)}catch(t){t instanceof ce||t=="unwind"||w(1,t)}}catch(t){t instanceof ce||t=="unwind"||w(1,t)}},Ht={},hr=()=>{if(!At){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:(typeof navigator=="object"&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:v||"./this.program"},t;for(t in Ht)Ht[t]===void 0?delete e[t]:e[t]=Ht[t];var r=[];for(t in e)r.push(`${t}=${e[t]}`);At=r}return At},At,Tt=e=>{var t=Pe(e)+1,r=xe(t);return Ne(e,M,r,t),r},Wr=(e,t,r,s)=>{var l={string:z=>{var oe=0;return z!=null&&z!==0&&(oe=Tt(z)),oe},array:z=>{var oe=xe(z.length);return x.set(z,oe),oe}};e=n["_"+e];var h=[],g=0;if(s)for(var A=0;A<s.length;A++){var X=l[r[A]];X?(g===0&&(g=Ue()),h[A]=X(s[A])):h[A]=s[A]}return r=e(...h),r=function(z){return g!==0&&ze(g),t==="string"?z?ie(M,z):"":t==="boolean"?!!z:z}(r)},tt=0,rt=(e,t)=>(t=t==1?xe(e.length):$t(e.length),e.subarray||e.slice||(e=new Uint8Array(e)),M.set(e,t),t),Te,Rt=[],_e,ke=e=>{Te.delete(_e.get(e)),_e.set(e,null),Rt.push(e)},je=(e,t)=>{if(!Te){Te=new WeakMap;var r=_e.length;if(Te)for(var s=0;s<0+r;s++){var l=_e.get(s);l&&Te.set(l,s)}}if(r=Te.get(e)||0)return r;if(Rt.length)r=Rt.pop();else{try{_e.grow(1)}catch(X){throw X instanceof RangeError?"Unable to grow wasm table. Set ALLOW_TABLE_GROWTH.":X}r=_e.length-1}try{_e.set(r,e)}catch(X){if(!(X instanceof TypeError))throw X;if(typeof WebAssembly.Function=="function"){var h=WebAssembly.Function;s={i:"i32",j:"i64",f:"f32",d:"f64",e:"externref",p:"i32"},l={parameters:[],results:t[0]=="v"?[]:[s[t[0]]]};for(var g=1;g<t.length;++g)l.parameters.push(s[t[g]]);t=new h(l,e)}else{s=[1],l=t.slice(0,1),t=t.slice(1),g={i:127,p:127,j:126,f:125,d:124,e:111},s.push(96);var A=t.length;128>A?s.push(A):s.push(A%128|128,A>>7);for(h of t)s.push(g[h]);l=="v"?s.push(0):s.push(1,g[l]),t=[0,97,115,109,1,0,0,0,1],h=s.length,128>h?t.push(h):t.push(h%128|128,h>>7),t.push(...s),t.push(2,7,1,1,101,1,102,0,0,7,5,1,1,102,0,0),t=new WebAssembly.Module(new Uint8Array(t)),t=new WebAssembly.Instance(t,{e:{f:e}}).exports.f}_e.set(r,t)}return Te.set(e,r),r};Me=Array(4096),rr(j,"/"),Ee("/tmp"),Ee("/home"),Ee("/home/web_user"),function(){Ee("/dev"),kt(259,{read:()=>0,write:(s,l,h,g)=>g,Va:()=>0}),Ke("/dev/null",259),zt(1280,Hr),zt(1536,Ar),Ke("/dev/tty",1280),Ke("/dev/tty1",1536);var e=new Uint8Array(1024),t=0,r=()=>(t===0&&(Vt(e),t=e.byteLength),e[--t]);De("random",r),De("urandom",r),Ee("/dev/shm"),Ee("/dev/shm/tmp")}(),function(){Ee("/proc");var e=Ee("/proc/self");Ee("/proc/self/fd"),rr({Xa(){var t=Jt(e,"fd",16895,73);return t.Ma={Va:j.Ma.Va},t.La={lookup(r,s){r=+s;var l=pe(r);return r={parent:null,Xa:{zb:"fake"},La:{readlink:()=>l.path},id:r+1},r.parent=r},readdir(){return Array.from(qe.entries()).filter(([,r])=>r).map(([r])=>r.toString())}},t}},"/proc/self/fd")}(),j.vb=new N(44),j.vb.stack="<generic error, no stack>";var jr={a:(e,t,r,s)=>P(`Assertion failed: ${e?ie(M,e):""}, at: `+[t?t?ie(M,t):"":"unknown filename",r,s?s?ie(M,s):"":"unknown function"]),i:function(e,t){try{return e=e?ie(M,e):"",Je(e,t),0}catch(r){if(typeof re>"u"||r.name!=="ErrnoError")throw r;return-r.Pa}},L:function(e,t,r){try{if(t=t?ie(M,t):"",t=Ae(e,t),r&-8)return-28;var s=be(t,{$a:!0}).node;return s?(e="",r&4&&(e+="r"),r&2&&(e+="w"),r&1&&(e+="x"),e&&Ie(s,e)?-2:0):-44}catch(l){if(typeof re>"u"||l.name!=="ErrnoError")throw l;return-l.Pa}},j:function(e,t){try{var r=pe(e);return ir(r,r.node,t,!1),0}catch(s){if(typeof re>"u"||s.name!=="ErrnoError")throw s;return-s.Pa}},h:function(e){try{var t=pe(e);return Dt(t,t.node,{timestamp:Date.now(),Fb:!1}),0}catch(r){if(typeof re>"u"||r.name!=="ErrnoError")throw r;return-r.Pa}},b:function(e,t,r){Ze=r;try{var s=pe(e);switch(t){case 0:var l=et();if(0>l)break;for(;qe[l];)l++;return qr(s,l).fd;case 1:case 2:return 0;case 3:return s.flags;case 4:return l=et(),s.flags|=l,0;case 12:return l=et(),Z[l+0>>1]=2,0;case 13:case 14:return 0}return-28}catch(h){if(typeof re>"u"||h.name!=="ErrnoError")throw h;return-h.Pa}},g:function(e,t){try{var r=pe(e),s=r.node,l=r.Ma.Ta;e=l?r:s,l??=s.La.Ta,Xe(l);var h=l(e);return Ye(t,h)}catch(g){if(typeof re>"u"||g.name!=="ErrnoError")throw g;return-g.Pa}},H:function(e,t){t=-9007199254740992>t||9007199254740992<t?NaN:Number(t);try{if(isNaN(t))return 61;var r=pe(e);if(0>t||!(r.flags&2097155))throw new N(28);return or(r,r.node,t),0}catch(s){if(typeof re>"u"||s.name!=="ErrnoError")throw s;return-s.Pa}},G:function(e,t){try{if(t===0)return-28;var r=Pe("/")+1;return t<r?-68:(Ne("/",M,e,t),r)}catch(s){if(typeof re>"u"||s.name!=="ErrnoError")throw s;return-s.Pa}},K:function(e,t){try{return e=e?ie(M,e):"",Ye(t,Ve(e,!0))}catch(r){if(typeof re>"u"||r.name!=="ErrnoError")throw r;return-r.Pa}},C:function(e,t,r){try{return t=t?ie(M,t):"",t=Ae(e,t),Ee(t,r),0}catch(s){if(typeof re>"u"||s.name!=="ErrnoError")throw s;return-s.Pa}},J:function(e,t,r,s){try{t=t?ie(M,t):"";var l=s&256;return t=Ae(e,t,s&4096),Ye(r,l?Ve(t,!0):Ve(t))}catch(h){if(typeof re>"u"||h.name!=="ErrnoError")throw h;return-h.Pa}},x:function(e,t,r,s){Ze=s;try{t=t?ie(M,t):"",t=Ae(e,t);var l=s?et():0;return Be(t,r,l).fd}catch(h){if(typeof re>"u"||h.name!=="ErrnoError")throw h;return-h.Pa}},v:function(e,t,r,s){try{if(t=t?ie(M,t):"",t=Ae(e,t),0>=s)return-28;var l=be(t).node;if(!l)throw new N(44);if(!l.La.readlink)throw new N(28);var h=l.La.readlink(l),g=Math.min(s,Pe(h)),A=x[r+g];return Ne(h,M,r,s+1),x[r+g]=A,g}catch(X){if(typeof re>"u"||X.name!=="ErrnoError")throw X;return-X.Pa}},u:function(e){try{return e=e?ie(M,e):"",nr(e),0}catch(t){if(typeof re>"u"||t.name!=="ErrnoError")throw t;return-t.Pa}},f:function(e,t){try{return e=e?ie(M,e):"",Ye(t,Ve(e))}catch(r){if(typeof re>"u"||r.name!=="ErrnoError")throw r;return-r.Pa}},r:function(e,t,r){try{return t=t?ie(M,t):"",t=Ae(e,t),r===0?sr(t):r===512?nr(t):P("Invalid flags passed to unlinkat"),0}catch(s){if(typeof re>"u"||s.name!=="ErrnoError")throw s;return-s.Pa}},q:function(e,t,r){try{t=t?ie(M,t):"",t=Ae(e,t,!0);var s=Date.now(),l,h;if(r){var g=I[r>>2]+4294967296*$[r+4>>2],A=$[r+8>>2];A==1073741823?l=s:A==1073741822?l=null:l=1e3*g+A/1e6,r+=16,g=I[r>>2]+4294967296*$[r+4>>2],A=$[r+8>>2],A==1073741823?h=s:A==1073741822?h=null:h=1e3*g+A/1e6}else h=l=s;if((h??l)!==null){e=l;var X=be(t,{$a:!0}).node;Xe(X.La.Ua)(X,{atime:e,mtime:h})}return 0}catch(z){if(typeof re>"u"||z.name!=="ErrnoError")throw z;return-z.Pa}},m:()=>P(""),l:()=>{Se=!1,Ct=0},A:function(e,t){e=-9007199254740992>e||9007199254740992<e?NaN:Number(e),e=new Date(1e3*e),$[t>>2]=e.getSeconds(),$[t+4>>2]=e.getMinutes(),$[t+8>>2]=e.getHours(),$[t+12>>2]=e.getDate(),$[t+16>>2]=e.getMonth(),$[t+20>>2]=e.getFullYear()-1900,$[t+24>>2]=e.getDay();var r=e.getFullYear();$[t+28>>2]=(r%4!==0||r%100===0&&r%400!==0?Pr:Fr)[e.getMonth()]+e.getDate()-1|0,$[t+36>>2]=-(60*e.getTimezoneOffset()),r=new Date(e.getFullYear(),6,1).getTimezoneOffset();var s=new Date(e.getFullYear(),0,1).getTimezoneOffset();$[t+32>>2]=(r!=s&&e.getTimezoneOffset()==Math.min(s,r))|0},y:function(e,t,r,s,l,h,g){l=-9007199254740992>l||9007199254740992<l?NaN:Number(l);try{if(isNaN(l))return 61;var A=pe(s);if(t&2&&!(r&2)&&(A.flags&2097155)!==2)throw new N(2);if((A.flags&2097155)===1)throw new N(2);if(!A.Ma.ib)throw new N(43);if(!e)throw new N(28);var X=A.Ma.ib(A,e,l,t,r),z=X.Kb;return $[h>>2]=X.Ab,I[g>>2]=z,0}catch(oe){if(typeof re>"u"||oe.name!=="ErrnoError")throw oe;return-oe.Pa}},z:function(e,t,r,s,l,h){h=-9007199254740992>h||9007199254740992<h?NaN:Number(h);try{var g=pe(l);if(r&2){if(r=h,(g.node.mode&61440)!==32768)throw new N(43);if(!(s&2)){var A=M.slice(e,e+t);g.Ma.jb&&g.Ma.jb(g,A,r,t,s)}}}catch(X){if(typeof re>"u"||X.name!=="ErrnoError")throw X;return-X.Pa}},n:(e,t)=>{if(We[e]&&(clearTimeout(We[e].id),delete We[e]),!t)return 0;var r=setTimeout(()=>{delete We[e],Vr(()=>dr(e,performance.now()))},t);return We[e]={id:r,Xb:t},0},B:(e,t,r,s)=>{var l=new Date().getFullYear(),h=new Date(l,0,1).getTimezoneOffset();l=new Date(l,6,1).getTimezoneOffset(),I[e>>2]=60*Math.max(h,l),$[t>>2]=+(h!=l),t=g=>{var A=Math.abs(g);return`UTC${0<=g?"-":"+"}${String(Math.floor(A/60)).padStart(2,"0")}${String(A%60).padStart(2,"0")}`},e=t(h),t=t(l),l<h?(Ne(e,M,r,17),Ne(t,M,s,17)):(Ne(e,M,s,17),Ne(t,M,r,17))},d:()=>Date.now(),s:()=>2147483648,c:()=>performance.now(),o:e=>{var t=M.length;if(e>>>=0,2147483648<e)return!1;for(var r=1;4>=r;r*=2){var s=t*(1+.2/r);s=Math.min(s,e+100663296);e:{s=(Math.min(2147483648,65536*Math.ceil(Math.max(e,s)/65536))-R.buffer.byteLength+65535)/65536|0;try{R.grow(s),V();var l=1;break e}catch{}l=void 0}if(l)return!0}return!1},E:(e,t)=>{var r=0;return hr().forEach((s,l)=>{var h=t+r;for(l=I[e+4*l>>2]=h,h=0;h<s.length;++h)x[l++]=s.charCodeAt(h);x[l]=0,r+=s.length+1}),0},F:(e,t)=>{var r=hr();I[e>>2]=r.length;var s=0;return r.forEach(l=>s+=l.length+1),I[t>>2]=s,0},e:function(e){try{var t=pe(e);return Lt(t),0}catch(r){if(typeof re>"u"||r.name!=="ErrnoError")throw r;return r.Pa}},p:function(e,t){try{var r=pe(e);return x[t]=r.tty?2:de(r.mode)?3:(r.mode&61440)===40960?7:4,Z[t+2>>1]=0,F[t+8>>3]=BigInt(0),F[t+16>>3]=BigInt(0),0}catch(s){if(typeof re>"u"||s.name!=="ErrnoError")throw s;return s.Pa}},w:function(e,t,r,s){try{e:{var l=pe(e);e=t;for(var h,g=t=0;g<r;g++){var A=I[e>>2],X=I[e+4>>2];e+=8;var z=lr(l,x,A,X,h);if(0>z){var oe=-1;break e}if(t+=z,z<X)break;typeof h<"u"&&(h+=z)}oe=t}return I[s>>2]=oe,0}catch(fe){if(typeof re>"u"||fe.name!=="ErrnoError")throw fe;return fe.Pa}},D:function(e,t,r,s){t=-9007199254740992>t||9007199254740992<t?NaN:Number(t);try{if(isNaN(t))return 61;var l=pe(e);return ar(l,t,r),F[s>>3]=BigInt(l.position),l.ob&&t===0&&r===0&&(l.ob=null),0}catch(h){if(typeof re>"u"||h.name!=="ErrnoError")throw h;return h.Pa}},I:function(e){var r;try{var t=pe(e);return(r=t.Ma)!=null&&r.fsync?t.Ma.fsync(t):0}catch(s){if(typeof re>"u"||s.name!=="ErrnoError")throw s;return s.Pa}},t:function(e,t,r,s){try{e:{var l=pe(e);e=t;for(var h,g=t=0;g<r;g++){var A=I[e>>2],X=I[e+4>>2];e+=8;var z=ur(l,x,A,X,h);if(0>z){var oe=-1;break e}if(t+=z,z<X)break;typeof h<"u"&&(h+=z)}oe=t}return I[s>>2]=oe,0}catch(fe){if(typeof re>"u"||fe.name!=="ErrnoError")throw fe;return fe.Pa}},k:cr},T;(async function(){var r;function e(s){var l;return T=s.exports,R=T.M,V(),_e=T.O,K--,(l=n.monitorRunDependencies)==null||l.call(n,K),K==0&&U&&(s=U,U=null,s()),T}K++,(r=n.monitorRunDependencies)==null||r.call(n,K);var t={a:jr};return n.instantiateWasm?new Promise(s=>{n.instantiateWasm(t,(l,h)=>{e(l,h),s(l.exports)})}):(O??=n.locateFile?n.locateFile("sql-wasm.wasm",D):D+"sql-wasm.wasm",e((await he(t)).instance))})(),n._sqlite3_free=e=>(n._sqlite3_free=T.P)(e),n._sqlite3_value_text=e=>(n._sqlite3_value_text=T.Q)(e),n._sqlite3_prepare_v2=(e,t,r,s,l)=>(n._sqlite3_prepare_v2=T.R)(e,t,r,s,l),n._sqlite3_step=e=>(n._sqlite3_step=T.S)(e),n._sqlite3_reset=e=>(n._sqlite3_reset=T.T)(e),n._sqlite3_exec=(e,t,r,s,l)=>(n._sqlite3_exec=T.U)(e,t,r,s,l),n._sqlite3_finalize=e=>(n._sqlite3_finalize=T.V)(e),n._sqlite3_column_name=(e,t)=>(n._sqlite3_column_name=T.W)(e,t),n._sqlite3_column_text=(e,t)=>(n._sqlite3_column_text=T.X)(e,t),n._sqlite3_column_type=(e,t)=>(n._sqlite3_column_type=T.Y)(e,t),n._sqlite3_errmsg=e=>(n._sqlite3_errmsg=T.Z)(e),n._sqlite3_clear_bindings=e=>(n._sqlite3_clear_bindings=T._)(e),n._sqlite3_value_blob=e=>(n._sqlite3_value_blob=T.$)(e),n._sqlite3_value_bytes=e=>(n._sqlite3_value_bytes=T.aa)(e),n._sqlite3_value_double=e=>(n._sqlite3_value_double=T.ba)(e),n._sqlite3_value_int=e=>(n._sqlite3_value_int=T.ca)(e),n._sqlite3_value_type=e=>(n._sqlite3_value_type=T.da)(e),n._sqlite3_result_blob=(e,t,r,s)=>(n._sqlite3_result_blob=T.ea)(e,t,r,s),n._sqlite3_result_double=(e,t)=>(n._sqlite3_result_double=T.fa)(e,t),n._sqlite3_result_error=(e,t,r)=>(n._sqlite3_result_error=T.ga)(e,t,r),n._sqlite3_result_int=(e,t)=>(n._sqlite3_result_int=T.ha)(e,t),n._sqlite3_result_int64=(e,t)=>(n._sqlite3_result_int64=T.ia)(e,t),n._sqlite3_result_null=e=>(n._sqlite3_result_null=T.ja)(e),n._sqlite3_result_text=(e,t,r,s)=>(n._sqlite3_result_text=T.ka)(e,t,r,s),n._sqlite3_aggregate_context=(e,t)=>(n._sqlite3_aggregate_context=T.la)(e,t),n._sqlite3_column_count=e=>(n._sqlite3_column_count=T.ma)(e),n._sqlite3_data_count=e=>(n._sqlite3_data_count=T.na)(e),n._sqlite3_column_blob=(e,t)=>(n._sqlite3_column_blob=T.oa)(e,t),n._sqlite3_column_bytes=(e,t)=>(n._sqlite3_column_bytes=T.pa)(e,t),n._sqlite3_column_double=(e,t)=>(n._sqlite3_column_double=T.qa)(e,t),n._sqlite3_bind_blob=(e,t,r,s,l)=>(n._sqlite3_bind_blob=T.ra)(e,t,r,s,l),n._sqlite3_bind_double=(e,t,r)=>(n._sqlite3_bind_double=T.sa)(e,t,r),n._sqlite3_bind_int=(e,t,r)=>(n._sqlite3_bind_int=T.ta)(e,t,r),n._sqlite3_bind_text=(e,t,r,s,l)=>(n._sqlite3_bind_text=T.ua)(e,t,r,s,l),n._sqlite3_bind_parameter_index=(e,t)=>(n._sqlite3_bind_parameter_index=T.va)(e,t),n._sqlite3_sql=e=>(n._sqlite3_sql=T.wa)(e),n._sqlite3_normalized_sql=e=>(n._sqlite3_normalized_sql=T.xa)(e),n._sqlite3_changes=e=>(n._sqlite3_changes=T.ya)(e),n._sqlite3_close_v2=e=>(n._sqlite3_close_v2=T.za)(e),n._sqlite3_create_function_v2=(e,t,r,s,l,h,g,A,X)=>(n._sqlite3_create_function_v2=T.Aa)(e,t,r,s,l,h,g,A,X),n._sqlite3_update_hook=(e,t,r)=>(n._sqlite3_update_hook=T.Ba)(e,t,r),n._sqlite3_open=(e,t)=>(n._sqlite3_open=T.Ca)(e,t);var $t=n._malloc=e=>($t=n._malloc=T.Da)(e),nt=n._free=e=>(nt=n._free=T.Ea)(e);n._RegisterExtensionFunctions=e=>(n._RegisterExtensionFunctions=T.Fa)(e);var pr=(e,t)=>(pr=T.Ga)(e,t),dr=(e,t)=>(dr=T.Ha)(e,t),ze=e=>(ze=T.Ia)(e),xe=e=>(xe=T.Ja)(e),Ue=()=>(Ue=T.Ka)();n.stackSave=()=>Ue(),n.stackRestore=e=>ze(e),n.stackAlloc=e=>xe(e),n.cwrap=(e,t,r,s)=>{var l=!r||r.every(h=>h==="number"||h==="boolean");return t!=="string"&&l&&!s?n["_"+e]:(...h)=>Wr(e,t,r,h)},n.addFunction=je,n.removeFunction=ke,n.UTF8ToString=vt,n.ALLOC_NORMAL=tt,n.allocate=rt,n.allocateUTF8OnStack=Tt;function qt(){function e(){var l;if(n.calledRun=!0,!B){if(!n.noFSInit&&!Xt){var t,r;Xt=!0,s??=n.stdin,t??=n.stdout,r??=n.stderr,s?De("stdin",s):xt("/dev/tty","/dev/stdin"),t?De("stdout",null,t):xt("/dev/tty","/dev/stdout"),r?De("stderr",null,r):xt("/dev/tty1","/dev/stderr"),Be("/dev/stdin",0),Be("/dev/stdout",1),Be("/dev/stderr",1)}if(T.N(),Qt=!1,(l=n.onRuntimeInitialized)==null||l.call(n),n.postRun)for(typeof n.postRun=="function"&&(n.postRun=[n.postRun]);n.postRun.length;){var s=n.postRun.shift();se.unshift(s)}te(se)}}if(0<K)U=qt;else{if(n.preRun)for(typeof n.preRun=="function"&&(n.preRun=[n.preRun]);n.preRun.length;)Ce();te(ue),0<K?U=qt:n.setStatus?(n.setStatus("Running..."),setTimeout(()=>{setTimeout(()=>n.setStatus(""),1),e()},1)):e()}}if(n.preInit)for(typeof n.preInit=="function"&&(n.preInit=[n.preInit]);0<n.preInit.length;)n.preInit.pop()();return qt(),a}),ct)};typeof pt=="object"&&typeof $e=="object"?($e.exports=ht,$e.exports.default=ht):typeof define=="function"&&define.amd?define([],function(){return ht}):typeof pt=="object"&&(pt.Module=ht)});var Ln={};Mn(Ln,{default:()=>wt});module.exports=kn(Ln);var ae=require("obsidian");var ot=class{constructor(o,i){this.db=o;this.renderer=i;console.log("ResourceHelper] Constructor called")}async generate(){console.log("ResourceHelper] Starting bulk generation...");let o="BibResources";try{await this.ensureFolder(o);let i=0;for(let a of this.db.getTables()){let u=a.dbFile,n=this.db.getDb(u);if(!n){console.warn("ResourceHelper] DB not loaded:",u);continue}let d=u.match(/^([a-zA-Z]{3})/i),p=d?d[1].toUpperCase():"UNK",f=u.match(/_([^_.]+)(\.|$)/),m=f?f[1]:"unknown",v=`${o}/${p}`,w=`${v}/${m}`;await this.ensureFolder(v),await this.ensureFolder(w);let D=n.prepare(`
          SELECT BookID FROM ${this.db.escapeTable(a.tableName)}
          ORDER BY BookID, Chapter, Verse LIMIT 1
        `),_=null;if(D.step()){let S=D.getAsObject().BookID;_=this.db.getBookName(u,S)}if(D.free(),!_){console.warn("ResourceHelper] Could not resolve first book in",u);continue}let E=`${w}/${_}`;await this.ensureFolder(E);for(let S=1;S<=2;S++){console.log(`ResourceHelper] Rendering ${_} ${S} (${p}/${m})`);let H=await this.renderer.renderChapter(n,a,_,S);if(!H){console.warn("ResourceHelper] No content for",_,S);continue}let y=`${E}/Chapter ${S}.md`;if(await this.app.vault.adapter.exists(y)){console.log("ResourceHelper] File already exists (skipping):",y);continue}await this.app.vault.create(y,H),console.log("ResourceHelper] Created:",y),i++}}new Notice(`BibResources generated! (${i} files created)`),console.log("ResourceHelper] Bulk generation completed successfully")}catch(i){console.error("ResourceHelper] Bulk generation failed:",i),new Notice(`Bulk generation failed: ${i.message}`)}}async generateChapter(o,i){console.log("ResourceHelper] Starting single chapter generation..."),console.log("ResourceHelper] Reference:",o),console.log("ResourceHelper] Selected table:",i.dbFile,i.tableName);try{let{book:a,chapter:u}=this.parseReference(o);if(console.log("ResourceHelper] Parsed reference - book:",a,"chapter:",u),!a||u===null){console.error("ResourceHelper] Invalid reference format"),new Notice('Invalid reference \u2013 use "Book Chapter" or "Book Chapter!" (e.g. Esther A!)');return}let n=this.db.resolveBook(a);if(console.log("ResourceHelper] Canonical book name:",n),!n){console.error("ResourceHelper] Book not found in books.tsv:",a),new Notice(`Book "${a}" not found in books.tsv`);return}let d=this.db.getDb(i.dbFile);if(!d){console.error("ResourceHelper] Database not loaded:",i.dbFile),new Notice(`Database ${i.dbFile} not loaded`);return}let p=this.db.getBookId(i.dbFile,n);if(p===null){console.error("ResourceHelper] Book not found in this database:",n,i.dbFile),new Notice(`Book "${n}" not present in ${i.dbFile}`);return}let f=d.prepare(`
        SELECT 1 FROM ${this.db.escapeTable(i.tableName)}
        WHERE BookID = ? AND Chapter = ? LIMIT 1
      `);f.bind([p,u]);let m=f.step();if(f.free(),!m){console.error("ResourceHelper] Chapter not found:",n,u),new Notice(`Chapter ${u} not found in ${n}`);return}let v=i.dbFile,w=v.match(/^([a-zA-Z]{3})/i),D=w?w[1].toUpperCase():"UNK",_=v.match(/_([^_.]+)(\.|$)/),E=_?_[1]:"unknown",S="BibResources",H=`${S}/${D}`,y=`${H}/${E}`,C=`${y}/${n}`;await this.ensureFolder(S),await this.ensureFolder(H),await this.ensureFolder(y),await this.ensureFolder(C),console.log("ResourceHelper] Rendering chapter...");let R=await this.renderer.renderChapter(d,i,n,u);if(!R){console.error("ResourceHelper] Failed to render chapter:",n,u),new Notice(`Failed to render ${n} ${u}`);return}let B=`Chapter ${u}.md`,k=`${C}/${B}`;if(await this.app.vault.adapter.exists(k)){console.log("ResourceHelper] File already exists (skipping):",k),new Notice(`${n} ${u} already exists`);return}await this.app.vault.create(k,R),console.log("ResourceHelper] Successfully created:",k),new Notice(`Generated: ${n} ${u}
\u2192 ${k}`)}catch(a){console.error("ResourceHelper] Single chapter generation failed:",a),new Notice(`Failed to generate chapter: ${a.message}`)}}parseReference(o){let i=o.trim(),a=!1,u=i;i.endsWith("!")&&(a=!0,u=i.slice(0,-1).trim());let n=u.match(/^(.+?)\s+([\d,:\-\s]+)$/i);if(!n)return{book:null,passages:null};let d=n[1].trim(),p=n[2].trim();return{book:d,passages:p}}async ensureFolder(o){console.log("ResourceHelper] Ensuring folder exists:",o);try{await this.app.vault.adapter.exists(o)?console.log("ResourceHelper] Folder already exists:",o):(await this.app.vault.createFolder(o),console.log("ResourceHelper] Folder created:",o))}catch(i){throw console.error("ResourceHelper] Error ensuring folder",o,":",i),i}}get app(){return window.app}};function at(Q){let o=String(Q??"").trim();if(!o)return{num:1/0,suffix:""};let i=Number(o);if(!isNaN(i)&&String(i)===o)return{num:i,suffix:""};let a="",u=o;for(;u.length>0;){let d=u[u.length-1];if(/[a-zA-Z]/.test(d))a=d+a,u=u.slice(0,-1);else break}return{num:Number(u)||1/0,suffix:a.toLowerCase()}}var Oe=class{constructor(o){this.db=o;this.pendingVerseRanges=[];console.log("RenderHelper] Constructor called")}getBookChapterList(o,i){try{let a=o.prepare("SELECT Chapters FROM books WHERE name = ?");if(a.bind([i]),a.step()){let u=a.getAsObject().Chapters;return a.free(),u?u.split(",").map(n=>n.trim()).map(n=>{let d=parseInt(n,10);return isNaN(d)?n:d}):[]}a.free()}catch(a){console.error("Failed to get chapter list for book:",i,a)}return[]}parseCrossChapterReference(o,i,a){let u=this.getBookChapterList(i,a);if(u.length===0)return console.warn("No chapter list for book:",a),[];let n=[],d=null,p=o.split(",").map(f=>f.trim()).filter(Boolean);for(let f of p){let m=f.match(/^(.+?)!:(.+)$/);if(m){let _=m[1].trim(),E=m[2].trim(),S=this.parseChapterLabel(_);if(u.includes(S)){d=S;let H=this.parseVerseRangeSimple(E);n.push({chapter:S,verses:H})}continue}let v=f.match(/^(\d+):(\d+)-(\d+):(\d+)$/);if(v){let _=parseInt(v[1],10),E=parseInt(v[2],10),S=parseInt(v[3],10),H=parseInt(v[4],10),y=u.indexOf(_),C=u.indexOf(S);if(y===-1||C===-1||y>=C)continue;n.push({chapter:_,verses:this.range(E,1/0)});for(let R=y+1;R<C;R++)n.push({chapter:u[R],verses:this.range(1,1/0)});n.push({chapter:S,verses:this.range(1,H)}),d=S;continue}let w=f.match(/^(\d+):(.+)$/);if(w){let _=parseInt(w[1],10),E=w[2].trim();if(u.includes(_)){d=_;let S=this.parseVerseRangeSimple(E);n.push({chapter:_,verses:S})}continue}if(d!==null&&/^\d+$/.test(f)){let _=this.parseVerseRangeSimple(f);n.push({chapter:d,verses:_});continue}if(f.match(/^(\d+)$/)){let _=parseInt(f,10);u.includes(_)&&(d=_);continue}}return n}parseVerseRangeSimple(o){if(!o)return[];let i=new Set,a=o.split(",").map(u=>u.trim());for(let u of a)if(u.includes("-")){let[n,d]=u.split("-").map(p=>parseInt(p.trim(),10));if(!isNaN(n)&&!isNaN(d))for(let p=n;p<=d;p++)i.add(p)}else{let n=parseInt(u,10);!isNaN(n)&&n>0&&i.add(n)}return Array.from(i).sort((u,n)=>u-n)}range(o,i){if(i===1/0)return Array.from({length:1e3},(u,n)=>o+n);let a=Math.max(0,i-o+1);return Array.from({length:a},(u,n)=>o+n)}parseChapterLabel(o){let i=parseInt(o,10);return isNaN(i)?o:i}async renderChapter(o,i,a,u){console.log("Rendering chapter:",a,u);try{let n=i.hasSubWordIndex,d=i.hasNewLine,p=i.hasLanguage,f=i.hasMacronized,m=i.hasNoNiqqud,v=["rowid","Word","Verse","BookID"];n&&v.push("SubWordIndex"),d&&v.push("NewLine"),p&&v.push("Language"),f&&v.push("Macronized"),m&&v.push("NoNiqqud");let w=this.db.getBookId(i.dbFile,a);if(w===null)return console.error("[RenderHelper] Book not found in books table:",a),null;let D=`SELECT ${v.join(", ")} FROM ${this.db.escapeTable(i.tableName)} WHERE BookID = ? AND Chapter = ? ORDER BY Verse, rowid`,_=o.prepare(D);_.bind([w,u]);let E=[],S="E";for(;_.step();){let F=_.getAsObject(),G=F.Word;if(G==null||typeof G!="string"){console.warn(`[RenderHelper] Null or invalid text found for ${a} ${u}:${F.Verse}. Skipping word.`);continue}let ee=F.rowid,V=F.Verse,K=!1;if(d&&(K=F.NewLine===1),p){let ne=F.Language;ne&&typeof ne=="string"&&(S=ne.trim().toUpperCase())}let U,P,O=m?F.NoNiqqud:void 0;i.dbFile.includes("lxx")||i.dbFile.includes("gnt")?(U=G,P=G.normalize("NFD").replace(/\u0304/g,"").normalize("NFC")):f&&F.Macronized&&(U=F.Macronized,P=G);let J=!1;E.length&&n?F.SubWordIndex===1&&E[E.length-1].word!=="-"&&(J=!0):E.length&&!K&&(J=!0),J&&E.push({word:" ",newLine:!1,verseStr:V,rowid:0,lang:void 0,mac:void 0,noMac:void 0,noNiq:void 0}),E.push({word:G,mac:U,noMac:P,noNiq:O,newLine:K,lang:p?S:void 0,verseStr:V,rowid:ee})}if(_.free(),!E.length)return null;let H=new Map;for(let F of E){let G=H.get(F.verseStr)??[];G.push(F),H.set(F.verseStr,G)}let y=Array.from(H.keys()).sort((F,G)=>{let ee=at(F),V=at(G);return ee.num!==V.num?ee.num-V.num:(ee.suffix||"").localeCompare(V.suffix||"")});(i.dbFile.includes("lxx")||i.dbFile.includes("gnt"))&&(S="G");let R={H:"he",G:"el",E:"en"}[S]||"en",k=`<div class="chapter ${i.dbFile.includes("heb")?"hebrew":i.dbFile.includes("lxx")||i.dbFile.includes("gnt")?"greek":"english"}" lang="${R}" data-show-mac="1" data-show-niq="1" data-show-verse="1" data-db-file="${i.dbFile}" data-table="${i.tableName}">`,x="",M="",Z=!0,$=!1,I=()=>{x&&(k+=`<p>${x}</p>`,x="")},le=F=>{let{num:G}=at(F),ee=i.dbFile.includes("lxx"),V=typeof u=="number"?u:0,{sCh:K,sV:U}=this.db.getSyncedVerse(a,V,G,ee),P=`<span class="verseM" sCh="${K}" sV="${U}">${G}</span>`;x+=(Z?"":" ")+P+" ",Z=!1,$=!0};for(let F of y){let G=H.get(F);if(F!==M){M=F;let V=G.find(U=>U.word!==" ");(V==null?void 0:V.newLine)===!0&&x&&I(),le(F)}for(let V of G){if(V.newLine&&x&&!$&&I(),V.word===" "){x+="<span> </span>";continue}let K=`<span class="Word" data-db="${V.rowid}">`;if(i.dbFile.includes("lxx")||i.dbFile.includes("gnt")){let U=V.mac||V.word,P=V.noMac||V.word;K+=`<span class="Mac">${this.escapeHtml(U)}</span>`,K+=`<span class="noMac">${this.escapeHtml(P)}</span>`}else if(i.dbFile.includes("heb")){let U=V.word,P=V.noNiq||this.stripNiqqud(V.word);K+=`<span class="N">${this.escapeHtml(U)}</span>`,K+=`<span class="nN">${this.escapeHtml(P)}</span>`}else K+=this.escapeHtml(V.word);K+="</span>",x+=K,$=!1}}return x&&I(),k+="</div>",k=this.cleanupHtml(k),k}catch(n){return console.error("Render failed:",n),null}}cleanupHtml(o){let i=/<p>\s*<span class="verseM"[^>]*>\d+<\/span>\s*<\/p>/g;return o=o.replace(i,""),o=o.replace(/<\/p>\s*<p>/g,"</p><p>"),o=o.replace(/<p>\s*<\/p>/g,""),o.trim()}async renderPassage(o,i,a,u,n){if(n===void 0)return this.renderChapter(o,i,a,u);this.pendingVerseRanges=[];let d=this.db.getBookId(i.dbFile,a);if(d===null)return null;let p=i.hasSubWordIndex,f=i.hasNewLine,m=i.hasLanguage,v=i.hasMacronized,w=i.hasNoNiqqud,D={H:"he",G:"el",E:"en"},_=[];if(typeof n=="string"&&(n.includes(":")||n.includes("!:")))_=this.parseCrossChapterReference(n,o,a);else{let x=typeof n=="string"?this.parseVerseRange(n):Array.isArray(n)?n.filter(M=>typeof M=="number"&&M>0):[n];_=[{chapter:u,verses:x}]}if(_.length===0)return null;let E=i.dbFile,H=`<div class="chapter passage ${E.includes("heb")?"hebrew":E.includes("lxx")||E.includes("gnt")?"greek":"english"}" data-show-mac="1" data-show-niq="1" data-show-verse="1" data-db-file="${i.dbFile}" data-table="${i.tableName}">`,y="",C=!0,R=!1,B=()=>{y&&(H+=`<p>${y}</p>`,y="")},k=(x,M)=>{let Z=i.dbFile.includes("lxx"),$=typeof M=="number"?M:0,{sCh:I,sV:le}=this.db.getSyncedVerse(a,$,x,Z);y+=`${C?"":" "}<span class="verseM" sCh="${I}" sV="${le}">${x}</span> `,C=!1,R=!0};for(let x of _){let M=x.chapter,Z=x.verses;if(Z.length===0)continue;C||(B(),H+=`<h2 class="chapter-heading">${a} ${M}</h2>`);let $=Z.slice().sort((O,J)=>O-J),I=[];for(let O of $)I.length===0||I[I.length-1].end+1<O?I.push({start:O,end:O}):I[I.length-1].end=O;this.pendingVerseRanges=I;let le=Z.map(()=>"?").join(","),F=`
      SELECT rowid, Word, Verse, ${p?"SubWordIndex,":""}
             ${f?"NewLine,":""}
             ${m?"Language,":""}
             ${v?"Macronized,":""}
             ${w?"NoNiqqud,":""}
             1
      FROM ${this.db.escapeTable(i.tableName)}
      WHERE BookID = ? AND Chapter = ? AND Verse IN (${le})
      ORDER BY Verse, rowid
    `,G=o.prepare(F);G.bind([d,M,...Z]);let ee=[],V="E";for(;G.step();){let O=G.getAsObject(),J=O.Word;if(J==null||typeof J!="string"){console.warn(`[RenderHelper] Null or invalid text found for ${a} ${M}:${O.Verse}. Skipping word.`);continue}let ne=O.rowid,he=O.Verse,ce=String(he),te=!1;if(f&&(te=O.NewLine===1),m){let Se=O.Language;Se&&typeof Se=="string"&&(V=Se.trim().toUpperCase())}let se,ue,Ce=w?O.NoNiqqud:void 0;i.dbFile.includes("lxx")||i.dbFile.includes("gnt")?(se=J,ue=J.normalize("NFD").replace(/\u0304/g,"").normalize("NFC")):v&&O.Macronized&&(se=O.Macronized,ue=J);let ge=!1;ee.length&&p?O.SubWordIndex===1&&ee[ee.length-1].word!=="-"&&(ge=!0):ee.length&&!te&&(ge=!0),ge&&ee.push({word:" ",newLine:!1,verseNum:he,rowid:0,lang:void 0,mac:void 0,noMac:void 0,noNiq:void 0}),ee.push({word:J,mac:se,noMac:ue,noNiq:Ce,newLine:te,lang:m?V:void 0,verseNum:he,rowid:ne})}if(G.free(),ee.length===0)continue;let K=new Map;for(let O of ee){let J=O.verseNum;K.has(J)||K.set(J,[]),K.get(J).push(O)}let U=Array.from(K.keys()).sort((O,J)=>O-J),P=0;for(let O of U){let J=K.get(O),ne=J.find(te=>te.word!==" "),he=(ne==null?void 0:ne.newLine)===!0,ce=P<this.pendingVerseRanges.length&&O===this.pendingVerseRanges[P].start;(ce&&P>0&&y||he&&y)&&B(),k(O,M);for(let te of J){if(te.newLine&&y&&!R&&B(),te.word===" "){y+="<span> </span>";continue}let se=`<span class="Word" data-db="${te.rowid}">`;if(i.dbFile.includes("lxx")||i.dbFile.includes("gnt")){let ue=te.mac||te.word,Ce=te.noMac||te.word;se+=`<span class="Mac">${this.escapeHtml(ue)}</span>`,se+=`<span class="noMac">${this.escapeHtml(Ce)}</span>`}else if(i.dbFile.includes("heb")){let ue=te.word,Ce=te.noNiq||this.stripNiqqud(te.word);se+=`<span class="N">${this.escapeHtml(ue)}</span>`,se+=`<span class="nN">${this.escapeHtml(Ce)}</span>`}else se+=this.escapeHtml(te.word);se+="</span>",y+=se,R=!1}ce&&O===this.pendingVerseRanges[P].end&&P++}}return y&&B(),H+="</div>",H=this.cleanupHtml(H),H}parseVerseRange(o){let i=new Set,a=o.split(",").map(d=>d.trim()).filter(Boolean);for(let d of a)if(d.includes("-")){let[p,f]=d.split("-").map(w=>w.trim()),m=parseInt(p,10),v=parseInt(f,10);if(!isNaN(m)&&!isNaN(v)&&m<=v)for(let w=m;w<=v;w++)i.add(w)}else{let p=parseInt(d,10);!isNaN(p)&&p>0&&i.add(p)}let u=Array.from(i).sort((d,p)=>d-p),n=[];for(let d of u)n.length===0||n[n.length-1].end+1<d?n.push({start:d,end:d}):n[n.length-1].end=d;return this.pendingVerseRanges=n,u}escapeHtml(o){return o.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}stripNiqqud(o){return o.replace(/[\u0591-\u05C7]/g,"")}};var lt=class Q{static hasColumn(o,i,a,u){try{let n=o.prepare(`PRAGMA table_info(${u(i)})`);for(;n.step();)if(n.getAsObject().name.toLowerCase()===a.toLowerCase())return n.free(),!0;n.free()}catch{}return!1}static async getHebrew(o,i,a,u){let d=["GrammarVariants","PartOfSpeech","Stem","Type","Person","Gender","Number","State","Translation"].filter(v=>Q.hasColumn(o,i,v,u));if(!d.length)return{grammar:"",translation:""};let p=o.prepare(`SELECT ${d.join(", ")} FROM ${u(i)} WHERE rowid = ?`);if(p.bind([a]),!p.step())return p.free(),{grammar:"",translation:""};let f=p.getAsObject(),m=[];return f.GrammarVariants&&m.push(f.GrammarVariants),["PartOfSpeech","Stem","Type","Person","Gender","Number","State"].forEach(v=>{let w=f[v];w&&m.push(w)}),p.free(),{grammar:m.length?m.join(" "):"",translation:f.Translation||""}}static async getLxx(o,i,a,u){let d=["PartOfSpeech","Tense","Mood","Person","Number","Case","Gender","IsName"].filter(v=>Q.hasColumn(o,i,v,u));if(!d.length)return"";let p=o.prepare(`SELECT ${d.map(v=>`"${v}"`).join(", ")} FROM ${u(i)} WHERE rowid = ?`);if(p.bind([a]),!p.step())return p.free(),"";let f=p.getAsObject(),m=[];if(f.PartOfSpeech&&m.push(f.PartOfSpeech),f.Tense&&m.push(f.Tense),f.Mood&&m.push(f.Mood),f.Person&&m.push(f.Person),f.Number&&m.push(f.Number),f.Case&&m.push(f.Case),f.Gender&&m.push(f.Gender),f.IsName!=null){let v=f.IsName;(v===1||v==="1"||v===!0||v==="true")&&m.push("Proper")}return p.free(),m.length?m.join(" "):""}},ut=class{constructor(o,i,a,u){this.app=o;this.plugin=i;this.db=a;this.settings=u;this.tooltipEl=null;this.timeout=null;this.watchedDocs=new Set;this.pinnedElement=null;this.pinnedContent="";this.lastHoverContent="";this.wordStatusMap=new Map;this.boundMouseOver=this.onMouseOver.bind(this),this.boundMouseOut=this.onMouseOut.bind(this),this.boundGlobalClick=this.onGlobalClick.bind(this),this.applyColors()}async loadStatuses(o){for(let i in o){let a=o[i],u=a.resource,n=this.db.getDb(u);if(!n)continue;let d=this.db.getBookId(u,a.book);if(d===null)continue;let f=n.prepare(`SELECT rowid FROM ${this.db.escapeTable("data")} 
         WHERE BookID = ? AND Chapter = ? AND Verse = ? 
         ORDER BY rowid LIMIT 1 OFFSET ?`);if(f.bind([d,a.chapter,a.verse,a.number-1]),f.step()){let v=f.getAsObject().rowid,w=`${u}|${v}`;this.wordStatusMap.set(w,a.status)}f.free()}}createTooltipEl(o){this.tooltipEl&&this.tooltipEl.parentElement===o||(this.tooltipEl&&(this.tooltipEl.remove(),this.tooltipEl=null),this.tooltipEl=o.createEl("div",{attr:{id:"word-tooltip"},cls:"seraph-tooltip"}),this.tooltipEl.createEl("div",{attr:{id:"word-info-container"}}),this.tooltipEl.createEl("div",{attr:{id:"status-dropdown-container"}}),Object.assign(this.tooltipEl.style,{position:"fixed",zIndex:"10000",background:"var(--background-primary)",color:"var(--text-normal)",padding:"6px 10px",borderRadius:"6px",fontSize:"1em",display:"none",whiteSpace:"normal",maxWidth:"80vw",maxHeight:"60vh",overflow:"auto",boxShadow:"0 2px 6px rgba(0,0,0,0.2)",pointerEvents:"auto",lineHeight:"1.4"}),this.tooltipEl.on("change","#word-status-select",this.onStatusChange.bind(this)))}register(){this.watchDocument(document),this.app.workspace.iterateAllLeaves(o=>{let i=o.view.containerEl.ownerDocument;i&&this.watchDocument(i)}),this.app.workspace.on("window-open",o=>{this.watchDocument(o.doc)})}async onStatusChange(o){var u;let a=o.target.value;if(this.pinnedElement){let n=this.pinnedElement.closest(".chapter");if(!n)return;let d=n.getAttribute("data-db-file"),p=n.getAttribute("data-table");if(!d||!p)return;let f=this.db.getDb(d);if(!f)return;let m=this.pinnedElement.getAttribute("data-db"),v=m?Number(m):null;if(v!==null&&!isNaN(v)){let w=`${d}|${v}`;a!=="Normal"?this.wordStatusMap.set(w,a):this.wordStatusMap.delete(w),console.log(`Word ID ${v} status set to: ${a}`),this.pinnedContent=this.lastHoverContent,this.show(this.pinnedContent,this.pinnedElement,a);let D=f.prepare(`SELECT BookID, Chapter, Verse FROM ${this.db.escapeTable(p)} WHERE rowid = ?`);if(D.bind([v]),!D.step()){D.free();return}let _=D.getAsObject(),E=_.BookID,S=_.Chapter,H=_.Verse;D.free();let y=this.db.getBookName(d,E);if(!y)return;let C=f.prepare(`SELECT COUNT(*) as count FROM ${this.db.escapeTable(p)} 
           WHERE BookID = ? AND Chapter = ? AND Verse = ? AND rowid < ?`);C.bind([E,S,H,v]),C.step();let B=C.getAsObject().count+1;C.free();let k=`${d}|${y}|${S}|${H}|${B}`;a!=="Normal"?this.plugin.difficultyData[k]={resource:d,book:y,chapter:S,verse:H,number:B,status:a}:delete this.plugin.difficultyData[k],await this.plugin.saveDifficulty(),await((u=this.plugin.highlightManager)==null?void 0:u.refresh())}}}watchDocument(o){this.watchedDocs.has(o)||(this.watchedDocs.add(o),o.addEventListener("mouseover",this.boundMouseOver),o.addEventListener("mouseout",this.boundMouseOut),o.addEventListener("click",this.boundGlobalClick))}unregister(){this.tooltipEl&&(this.tooltipEl.remove(),this.tooltipEl=null);for(let o of this.watchedDocs)o.removeEventListener("mouseover",this.boundMouseOver),o.removeEventListener("mouseout",this.boundMouseOut),o.removeEventListener("click",this.boundGlobalClick);this.watchedDocs.clear()}updateSettings(o){this.settings=o,this.applyColors()}applyColors(){let o=this.settings.wordHoverColorLight||"#d35400",i=this.settings.wordHoverColorDark||"#f39c12";document.body.style.setProperty("--word-hover-light",o),document.body.style.setProperty("--word-hover-dark",i)}onGlobalClick(o){let a=o.target.closest(".Word");if(a){o.preventDefault(),o.stopPropagation(),this.pinnedElement&&this.pinnedElement!==a&&this.pinnedElement.classList.remove("seraph-highlight"),this.pinnedElement=a,this.pinnedContent=this.lastHoverContent,this.pinnedElement.classList.add("seraph-highlight"),this.createTooltipEl(a.ownerDocument.body);let u=this.pinnedElement.getAttribute("data-db"),n=u?Number(u):null,d;if(n!==null&&!isNaN(n)){let p=this.pinnedElement.closest(".chapter"),f=p==null?void 0:p.getAttribute("data-db-file");if(f){let m=`${f}|${n}`;d=this.wordStatusMap.get(m)}}this.show(this.pinnedContent,this.pinnedElement,d)}else this.pinnedElement&&(this.pinnedElement.classList.remove("seraph-highlight"),this.pinnedElement=null,this.pinnedContent=""),this.tooltipEl&&(this.tooltipEl.style.display="none")}async onMouseOver(o){let i=o.target;if(!i||!i.ownerDocument)return;let a=i.closest(".Word");if(!a)return;a.classList.add("seraph-highlight"),this.createTooltipEl(i.ownerDocument.body);let u=a.getAttribute("data-db");if(!u)return;this.timeout&&clearTimeout(this.timeout);let n=a.closest(".chapter");if(!n)return;let d=n.getAttribute("data-db-file"),p=n.getAttribute("data-table");if(!d||!p)return;let f=this.db.getDb(d);if(!f)return;let m=this.db.getStrongsInfo(d);if(!m||m.tableName!==p)return;let v="";try{let y=f.prepare(`SELECT ${m.column} FROM ${this.db.escapeTable(p)} WHERE rowid = ?`);y.bind([Number(u)]),y.step()&&(v=y.getAsObject()[m.column]??""),y.free()}catch{}let w="",D="";if(d.includes("heb")){let y=await lt.getHebrew(f,p,Number(u),this.db.escapeTable.bind(this.db));w=y.grammar,D=y.translation}else d.includes("lxx")&&(w=await lt.getLxx(f,p,Number(u),this.db.escapeTable.bind(this.db)));let _=[`ID: ${u}`];if(v&&_.push(`${m.column}: ${v}`),d.includes("heb")?(w&&_.push(`Grammar: ${w}`),D&&_.push(`Translation: ${D}`)):d.includes("lxx")&&w&&_.push(`Grammar: ${w}`),this.db.getLexiconDb()&&v){let y=v.startsWith("G")?"gLex":v.startsWith("H")?"hLex":null;if(y)try{let C=this.db.getLexiconDb().prepare(`SELECT Word, Definition FROM ${this.db.escapeTable(y)} WHERE dStrong = ? LIMIT 1`);if(C.bind([v]),C.step()){let R=C.getAsObject();R.Word&&_.push(`Word: ${R.Word}`),R.Definition&&_.push(`Def: ${R.Definition}`)}C.free()}catch(C){console.warn("Lexicon failed:",C)}}let E=_.join(" | ");this.lastHoverContent=E;let S=`${d}|${u}`,H=this.wordStatusMap.get(S);this.show(E,a,H)}onMouseOut(o){let a=o.target.closest(".Word");if(a)if(a!==this.pinnedElement&&a.classList.remove("seraph-highlight"),this.pinnedElement){let u=this.pinnedElement.getAttribute("data-db"),n=u?Number(u):null,d;n!==null&&!isNaN(n)&&(d=this.wordStatusMap.get(n)),this.show(this.pinnedContent,this.pinnedElement,d)}else this.timeout=window.setTimeout(()=>{this.tooltipEl&&(this.tooltipEl.style.display="none")},120)}show(o,i=null,a){if(!this.tooltipEl)return;if(!o||o.trim()===""){this.tooltipEl.style.display="none";return}let u=this.tooltipEl.querySelector("#word-info-container"),n=this.tooltipEl.querySelector("#status-dropdown-container");if(u&&(u.innerHTML=o.replace(/ \| /g,"<br>")),n&&i&&i===this.pinnedElement){let p=i.getAttribute("data-db"),f=p?Number(p):null,m=a??"Normal";if(f!==null&&!isNaN(f)){let D=i.closest(".chapter"),_=D==null?void 0:D.getAttribute("data-db-file");if(_){let E=`${_}|${f}`;this.wordStatusMap.has(E)&&(m=this.wordStatusMap.get(E))}}let v=["Normal","Hard","Challenging","Unrecognized","Strange Meaning"],w='<hr style="border-top: 1px solid var(--background-modifier-border);">';w+='<div><label for="word-status-select" style="font-weight: bold; margin-right: 5px;">Status:</label>',w+='<select id="word-status-select" style="padding: 2px; border-radius: 4px; background: var(--background-secondary); color: var(--text-normal);">',v.forEach(D=>{w+=`<option value="${D}" ${D===m?"selected":""}>${D}</option>`}),w+="</select></div>",n.innerHTML=w,n.style.display="block"}else n&&(n.style.display="none");this.tooltipEl.style.display="block";let d=null;if(i&&(d=i.closest(".markdown-preview-view")||i.closest(".markdown-source-view")),d){let p=d.getBoundingClientRect(),f=this.tooltipEl.offsetHeight;this.tooltipEl.style.left=`${p.left+10}px`;let m=p.bottom-f-10;m<p.top&&(m=p.top+10),this.tooltipEl.style.top=`${m}px`,this.tooltipEl.style.right="auto",this.tooltipEl.style.bottom="auto"}else this.tooltipEl.style.left="10px",this.tooltipEl.style.bottom="10px",this.tooltipEl.style.top="auto",this.tooltipEl.style.right="auto"}};var Mr=Dn(Sr()),dt=class{constructor(o,i){this.app=o;this.pluginId=i;this.dbs=new Map;this.tables=[];this.strongsInfo=new Map;this.bookMap=new Map;this.bookIdToName=new Map;this.parallelDb=null;this.lexiconDb=null;this.lxxVerseMap=new Map;console.log("DbHelper] Constructor called with pluginId:",this.pluginId)}async init(){console.log("DbHelper] Starting init()...");let o=`.obsidian/plugins/${this.pluginId}`,i=`${o}/sql-wasm.wasm`;try{console.log("DbHelper] Loading wasm binary from:",i);let a=await this.app.vault.adapter.readBinary(i);console.log("DbHelper] WASM binary loaded, size:",a.length);let u=await(0,Mr.default)({wasmBinary:new Uint8Array(a)});console.log("DbHelper] SQL.js initialized"),await this.loadDatabases(u,o),console.log("DbHelper] Databases loaded, found",this.tables.length,"tables"),await this.loadBookMap(o),console.log("DbHelper] Book map loaded, found",this.bookMap.size,"aliases"),await this.loadParallelDb(u,o),console.log("DbHelper] Parallel DB loaded"),await this.loadLexiconDb(u,o),console.log("DbHelper] Lexicon DB loaded"),console.log("DbHelper] init() completed successfully")}catch(a){throw console.error("DbHelper] init() failed:",a),a}}async loadDatabases(o,i){console.log("DbHelper] Loading databases from:",i);let a=`${i}/resources`,n=(await this.app.vault.adapter.list(a)).files.filter(d=>d.endsWith(".db"));console.log("DbHelper] Found",n.length,"database files");for(let d of n){if(!await this.app.vault.adapter.exists(d))continue;let p=d.split("/").pop(),f=await this.app.vault.adapter.readBinary(d),m=new o.Database(new Uint8Array(f));if(m.run("PRAGMA foreign_keys = ON;"),this.dbs.set(p,m),!this.hasTable(m,"data")){console.warn("DbHelper] Skipping",p,'- no "data" table');continue}let w="data";if(!this.hasColumn(m,w,"BookID")){console.error(`DbHelper] ${p} has no BookID column in 'data' table`);continue}let D=this.hasColumn(m,w,"SubWordIndex"),_=this.hasColumn(m,w,"NewLine"),E=this.hasColumn(m,w,"Language"),S=this.hasColumn(m,w,"Macronized"),H=this.hasColumn(m,w,"NoNiqqud"),y={dbFile:p,tableName:w,hasSubWordIndex:D,hasNewLine:_,hasLanguage:E,hasMacronized:S,hasNoNiqqud:H,usesBookID:!0};if(this.tables.push(y),this.hasColumn(m,w,"Strongs")&&(this.strongsInfo.set(p,{dbFile:p,tableName:w,column:"Strongs"}),console.log("DbHelper] Found Strongs in",p)),this.hasTable(m,"books")){let C=new Map;try{let R=m.prepare(`
          SELECT * FROM books LIMIT 0
        `);R.step();let B=R.getColumnNames();R.free();let k=B.find($=>$.toLowerCase().includes("id"))||B[0],x=B.find($=>$.toLowerCase().includes("name"))||B[1]||B[0],M=`SELECT ${this.escapeTable(k)}, ${this.escapeTable(x)} FROM books`,Z=m.prepare(M);for(;Z.step();){let $=Z.getAsObject(),I=Number($[k]),le=String($[x]||"").trim();!isNaN(I)&&le&&C.set(I,le)}Z.free(),this.bookIdToName.set(p,C),console.log(`DbHelper] Loaded ${C.size} books from 'books' table in`,p)}catch(R){console.warn("DbHelper] Failed to read books table in",p,":",R)}}else console.warn('DbHelper] No "books" table found in',p,"- book name resolution will fail")}if(this.tables.length===0)throw console.error("DbHelper] No valid databases found"),new Error("No valid databases found");console.log("DbHelper] Successfully loaded",this.tables.length,"database(s)")}async loadBookMap(o){let i=`${o}/books.tsv`;if(!await this.app.vault.adapter.exists(i)){console.warn("DbHelper] books.tsv not found:",i);return}let u=(await this.app.vault.adapter.read(i)).trim().split(`
`);for(let n of u){let d=n.split("	").map(f=>f.trim()).filter(Boolean);if(!d.length)continue;let p=d[0];for(let f of d)this.bookMap.set(f.toLowerCase(),p)}console.log("DbHelper] Book alias map loaded with",this.bookMap.size,"entries")}async loadParallelDb(o,i){let a=`${i}/resources/helpers/parallel.db`;if(!await this.app.vault.adapter.exists(a))return;let u=await this.app.vault.adapter.readBinary(a);this.parallelDb=new o.Database(new Uint8Array(u));let n=this.parallelDb.prepare(`
      SELECT Book, Masoretic_Chapter, Masoretic_Verse, LXX_Chapter, LXX_Verse
      FROM parallel
    `),d=0;for(;n.step();){let p=n.getAsObject(),f=`${p.Book}|${p.LXX_Chapter}|${p.LXX_Verse}`;this.lxxVerseMap.set(f,{sCh:p.Masoretic_Chapter,sV:p.Masoretic_Verse}),d++}n.free(),console.log("DbHelper] Parallel DB loaded with",d,"mappings")}async loadLexiconDb(o,i){let a=`${i}/resources/helpers/lexiconData.db`;if(!await this.app.vault.adapter.exists(a))return;let u=await this.app.vault.adapter.readBinary(a);this.lexiconDb=new o.Database(new Uint8Array(u)),console.log("DbHelper] Lexicon DB loaded")}getSyncedVerse(o,i,a,u){if(!u||!this.parallelDb)return{sCh:i,sV:a};let n=`${o}|${i}|${a}`;return this.lxxVerseMap.get(n)??{sCh:i,sV:a}}hasColumn(o,i,a){try{let u=o.prepare(`PRAGMA table_info(${i})`);for(;u.step();)if(u.getAsObject().name.toLowerCase()===a.toLowerCase())return u.free(),!0;u.free()}catch{}return!1}hasTable(o,i){try{let a=o.prepare(`
      SELECT name FROM sqlite_master 
      WHERE type = 'table' AND name = ?
    `);a.bind([i]);let u=a.step();return a.free(),u}catch{return!1}}escapeTable(o){return`[${o.replace(/]/g,"]]")}]`}getDb(o){let i=this.dbs.get(o);return i||console.warn("DbHelper] Database not found:",o),i}getTables(){return this.tables}getStrongsInfo(o){return this.strongsInfo.get(o)}getLexiconDb(){return this.lexiconDb}resolveBook(o){let i=o.toLowerCase().trim();if(!i)return null;if(this.bookMap.has(i))return this.bookMap.get(i);let a=null,u=1/0;for(let[n,d]of this.bookMap){let p=xn(i,n);p<u&&(u=p,a=d)}return a&&u<=i.length?a:null}getBookName(o,i){let a=this.bookIdToName.get(o);return a?a.get(i)??null:null}getBookId(o,i){let a=this.bookIdToName.get(o);if(!a)return null;for(let[u,n]of a.entries())if(n.toLowerCase()===i.toLowerCase())return u;return null}unload(){console.log("DbHelper] Unloading databases...");for(let[o,i]of this.dbs)try{i.close()}catch{console.warn("Error closing",o)}this.parallelDb&&this.parallelDb.close(),this.lexiconDb&&this.lexiconDb.close()}};function xn(Q,o){let i=[];for(let a=0;a<=o.length;a++)i[a]=[a];for(let a=0;a<=Q.length;a++)i[0][a]=a;for(let a=1;a<=o.length;a++)for(let u=1;u<=Q.length;u++)o.charAt(a-1)===Q.charAt(u-1)?i[a][u]=i[a-1][u-1]:i[a][u]=Math.min(i[a-1][u-1]+1,i[a-1][u]+1,i[a][u-1]+1);return i[o.length][Q.length]}var gt=require("obsidian");var Dr={"engData_asv_data.db":"ASV","endData_bsb_data.db":"BSB","engData_bsb_data.db":"BSB","endData_kjva_data.db":"KJVA","engData_kjva_data.db":"KJVA","endData_leb_data.db":"LEB","engData_leb_data.db":"LEB","endData_net_data.db":"NET","engData_net_data.db":"NET","gntData_MorphGNT.db":"MorphGNT","gntData_Nestle1904.db":"NA1904","gntData_SBLGNT.db":"SBLGNT","gntData_TNT.db":"TNT","hebData.db":"Hebrew","lxxData.db":"LXX"},ft=class{constructor(o,i,a){this.app=o;this.db=i;this.kjvaTable=null;this.renderer=new Oe(this.db),this.settings=a||{referenceFormatBelow:!1,defaultOtVersions:["HEB","LXX","LEB"],defaultNtVersions:["KJVA","ASV","BSB"]};let u=this.db.getTables();this.kjvaTable=u.find(n=>n.dbFile.includes("engData_kjva")&&n.tableName==="data")||null,this.kjvaTable||console.warn("[SeraphProcessor] KJVA table not found \u2013 seraph blocks will fall back to available resources.")}register(o){o.registerMarkdownCodeBlockProcessor("seraph",(i,a,u)=>this.process(i,a,u))}getAbbreviationFromDbFile(o){let i=o.split("/").pop()||o;if(Dr[i])return Dr[i];if(i.includes("hebData"))return"Hebrew";if(i.includes("lxxData"))return"LXX";let a=i.match(/engData_(.+?)_data\.db/i);return a&&a[1]?a[1].toUpperCase():"RES"}isOldTestament(o){return["Genesis","Exodus","Leviticus","Numbers","Deuteronomy","Joshua","Judges","Ruth","1 Samuel","2 Samuel","1 Kings","2 Kings","1 Chronicles","2 Chronicles","Ezra","Nehemiah","Esther","Job","Psalms","Proverbs","Ecclesiastes","Song of Solomon","Isaiah","Jeremiah","Lamentations","Ezekiel","Daniel","Hosea","Joel","Amos","Obadiah","Jonah","Micah","Nahum","Habakkuk","Zephaniah","Haggai","Zechariah","Malachi"].includes(o)}mapAbbreviationToSearchKey(o){let i=o.toUpperCase();switch(i){case"HEB":return"HEBDATA";case"LXX":return"LXXDATA";default:return i}}parsePreferencesString(o){return o?o.split(",").map(i=>i.trim()).filter(i=>i.length>0).map(i=>this.mapAbbreviationToSearchKey(i)):[]}expandPassageParts(o,i){let a=[],u=null,n=d=>{let p=String(d).replace(/!/g,"").trim();return i.findIndex(f=>String(f)===p)};for(let d of o){let p=d.match(/^([\w!]+):(\d+)-([\w!]+):(\d+)$/);if(p){let m=p[1],v=p[2],w=p[3],D=p[4],_=n(m),E=n(w);if(_===-1||E===-1||_>E){a.push(d);continue}let S=i[_],H=i[E];if(_===E){a.push(d),u=S;continue}let y=String(S)+(typeof S=="string"?"!":"");a.push(`${y}:${v}-999`),u=S;for(let R=_+1;R<E;R++){let B=i[R],k=String(B)+(typeof B=="string"?"!":"");a.push(k),u=B}let C=String(H)+(typeof H=="string"?"!":"");a.push(`${C}:1-${D}`),u=H;continue}let f=d.match(/^([\w!]+):(.+)$/);if(f){let m=f[1],v=n(m);v!==-1&&(u=i[v])}else{let m=d.match(/^([\w!]+)$/);if(m){let v=m[1],w=n(v);w!==-1&&(u=i[w])}}a.push(d)}return a}async process(o,i,a){let u=o.split(/\n\+\+\+\s*\n?/),n=u.length>1?u[0].trim():"",d=u.length>1?u.slice(1).join(`
`):o,p=null,f=null,m=n.split(`
`),v=[];for(let k of m){let x=k.match(/^OT-Versions:\s*(.+)$/i),M=k.match(/^NT-Versions:\s*(.+)$/i);x?p=this.parsePreferencesString(x[1]):M?f=this.parsePreferencesString(M[1]):v.push(k)}n=v.join(`
`).trim();let w=d.split(/\n---\s*\n?/),D=w[0].trim(),_=w.length>1?w.slice(1).join(`
`).trim():"",E=i.createEl("div",{cls:"seraph-overall-container"}),S=this.settings.referenceFormatBelow?"below":"above";if(E.setAttribute("data-ref-pos",S),n){let k=E.createEl("div",{cls:"seraph-references-section"});k.createEl("p",{cls:"seraph-references-text"}).innerHTML=n,E.createEl("hr",{cls:"seraph-references-separator"})}let H=E.createEl("div",{cls:"seraph-top-section"}),y=D.split(`
`).filter(k=>k.trim()!==""),C=this.db.getTables(),R=this.parsePreferencesString(Array.isArray(this.settings.defaultOtVersions)?this.settings.defaultOtVersions.join(","):this.settings.defaultOtVersions),B=this.parsePreferencesString(Array.isArray(this.settings.defaultNtVersions)?this.settings.defaultNtVersions.join(","):this.settings.defaultNtVersions);for(let k of y){let x=H.createEl("div",{cls:"seraph-flip-section"}),M=k.split("|").map(I=>I.trim()).filter(I=>I.length>0),Z=x.createEl("div",{cls:"seraph-hsection-wrapper",attr:{"data-hsections-count":M.length},style:"display: flex; flex-wrap: wrap;"}),$=100/M.length;for(let I of M){let le=Z.createEl("div",{cls:"seraph-hsection",style:`flex: 0 0 ${$}%; max-width: ${$}%;`}),F=I.split(";").map(U=>U.trim()).filter(U=>U.length>0),G=[];for(let U of F){let P=null,O=U.match(/\(([\w,]+)\)\s*$/);O&&(P=this.parsePreferencesString(O[1]),U=U.replace(O[0],"").trim());let J=this.parseReference(U),ne=J.book?this.db.resolveBook(J.book):null;if(!ne)continue;let he=this.isOldTestament(ne),ce;P&&P.length>0?ce=P:he&&p?ce=p:!he&&f?ce=f:ce=he?R:B,ce.forEach(te=>{let se=C.find(ue=>ue.dbFile.toUpperCase().includes(te.toUpperCase()));se&&G.push({ref:U,dbTable:se})})}if(G.length===0)continue;let ee=le.createEl("div",{cls:"seraph-tabs-container seraph-master-cycle"}),V=[],K=0;for(let U=0;U<G.length;U++){let P=ee.createEl("div",{cls:"seraph-flip-tab",attr:{"data-tab-index":V.length}});V.length>0&&(P.style.display="none");let O=P.createEl("h1",{cls:"seraph-chapter-title seraph-ref-above"}),J=P.createEl("div",{cls:"tab-content"}),ne=P.createEl("p",{cls:"seraph-reference-footnote seraph-ref-below"});V.push(P)}if(G.length>1){let U=P=>{P.stopPropagation(),V[K].style.display="none",K=(K+1)%G.length,V[K].style.display="block"};V.forEach(P=>{let O=P.querySelector(".seraph-ref-above"),J=P.querySelector(".seraph-ref-below");[O,J].forEach(ne=>{ne&&(ne.classList.add("cycle-header"),ne.style.cursor="pointer",ne.addEventListener("click",U))})})}for(let U=0;U<G.length;U++){let P=G[U],O=V[U],J=O.querySelector(".seraph-ref-above"),ne=O.querySelector(".seraph-ref-below"),he=O.querySelector(".tab-content"),ce=await this.generateChapterHtml(P.ref,P.dbTable),te=this.getAbbreviationFromDbFile(P.dbTable.dbFile);if(ce){let se=`${this.formatReference(P.ref)} (${te})`;J.textContent=se,ne.textContent=`\u2014 ${se}`,he.innerHTML=ce;let ue=he.querySelector(".chapter");ue&&(ue.setAttribute("data-show-mac",this.settings.enableMacrons?"1":"0"),ue.setAttribute("data-show-niq",this.settings.enableNiqqud?"1":"0"),ue.setAttribute("data-show-verse",this.settings.enableVerseNumbers?"1":"0"),requestAnimationFrame(()=>{ue.style.display="block"}))}else{let se=`${this.formatReference(P.ref)} (${te})`;J.textContent=se,ne.textContent=`\u2014 ${se}`,he.textContent=`Passage not found in ${te}.`}}}}if(_){E.createEl("hr",{cls:"seraph-commentary-separator"});let x=E.createEl("div",{cls:"seraph-commentary-section"}).createEl("div",{cls:"seraph-commentary-text markdown-rendered"});await gt.MarkdownRenderer.render(this.app,_,x,a.sourcePath,new gt.Component)}}async generateChapterHtml(o,i){let a=this.parseReference(o);if(!a||!a.book||a.passages===null)return null;let u=this.db.resolveBook(a.book);if(!u)return null;let n=this.db.getDb(i.dbFile);if(!n||this.db.getBookId(i.dbFile,u)===null)return null;let p=a.passages.split(",").map(E=>E.trim()).filter(E=>E.length>0),f=this.renderer.getBookChapterList(n,u),m=[],v=a.passages.includes(":");if(v)m=this.expandPassageParts(p,f);else for(let E of p)if(E.includes("-")){let S=E.match(/^([\w!]+)-([\w!]+)$/);if(S){let H=S[1].replace(/!/g,""),y=S[2].replace(/!/g,""),C=k=>{let x=k.trim();for(let M=0;M<f.length;M++)if(String(f[M])===x)return M;return-1},R=C(H),B=C(y);if(R!==-1&&B!==-1&&R<=B)for(let k=R;k<=B;k++){let x=String(f[k]);isNaN(parseInt(x,10))?m.push(`${x}!`):m.push(x)}else m.push(E)}else m.push(E)}else m.push(E);let w=0,D=[],_=E=>{let S=E.replace(/!/g,"").trim();return f.some(H=>String(H)===S)};for(let E of m){let S=null,H=null,y=null,C=E.match(/^([A-Za-z0-9]+)!(?::(.*))?$/);if(C)S=C[1],H=C[2]?C[2].trim():null,w=S,y=H?`${S}:${H}`:`${S}`;else if(E.includes(":")){let B=E.match(/^([\w!]+):([\d\-A-Za-z]+)$/);if(B){let k=B[1].replace("!","");S=isNaN(parseInt(k,10))?k:parseInt(k,10),H=B[2].trim(),w=S,y=`${S}:${H}`}else{console.warn(`[SeraphProcessor] Unresolvable colon passage part: ${E} in ${o}`);continue}}else{let B=E.match(/^([\w!]+)(?:-([\w!]+))?$/);if(B){let k=B[1];if(_(k))S=isNaN(parseInt(k,10))?k:parseInt(k,10),H=null,w=S,y=String(S);else if(w!==0)S=w,H=E,y=`${S}:${H}`;else if(!v)S=isNaN(parseInt(k,10))?k:parseInt(k,10),H=null,w=S,y=String(S);else{console.warn(`[SeraphProcessor] Unresolvable passage part: ${E} in ${o} (No chapter context)`);continue}}else{console.warn(`[SeraphProcessor] Unresolvable bare passage part: ${E} in ${o}`);continue}}if(S===null)continue;let R=null;H?R=await this.renderer.renderPassage(n,i,u,S,H):R=await this.renderer.renderChapter(n,i,u,S),R?D.push(R):D.push(`<p>Passage not found: ${u} ${y??E}</p>`)}return D.length>0?D.join(""):null}parseReference(o){let a=o.trim(),u=a.match(/^(.+?)\s+([\w,:\-\s!]+)$/i);if(!u){let p=a.match(/^(.+?)$/i);return p?{book:p[1].trim(),passages:null}:{book:null,passages:null}}let n=u[1].trim(),d=u[2].trim();return{book:n,passages:d}}formatReference(o){let i=this.parseReference(o);if(!i.book||i.passages===null)return o;let a=this.db.resolveBook(i.book);if(!a)return o;let u=i.passages;return`${a} ${u}${o.endsWith("!")?"!":""}`}};var mt=class{constructor(o){this.plugin=o;this.plugin.app.workspace.on("layout-change",()=>this.applyAllHighlights()),this.plugin.register(()=>this.plugin.app.workspace.off("layout-change",this.applyAllHighlights.bind(this))),setTimeout(()=>this.applyAllHighlights(),800)}async refresh(){await this.plugin.tooltip.loadStatuses(this.plugin.difficultyData),this.applyAllHighlights()}applyAllHighlights(){document.querySelectorAll(".difficulty-highlight").forEach(o=>o.remove());for(let[o,i]of this.plugin.tooltip.wordStatusMap.entries()){if(i==="Normal")continue;let[a,u]=o.split("|"),n=Number(u);isNaN(n)||document.querySelectorAll(`.Word[data-db="${n}"]`).forEach(d=>{let p=d.closest(".chapter");!p||p.getAttribute("data-db-file")!==a||this.applyOverlayHighlight(d,i)})}}applyOverlayHighlight(o,i){o.querySelectorAll(".difficulty-highlight").forEach(p=>p.remove());let a=o.ownerDocument.createElement("div"),u=i==="Strange Meaning"?"strange-meaning":i.toLowerCase().replace(" ","-");a.className=`difficulty-highlight ${u}`,o.style.position="relative",o.appendChild(a);let n=()=>{Object.assign(a.style,{position:"absolute",inset:"0",pointerEvents:"none",borderRadius:"4px"})};n();let d=new ResizeObserver(n);d.observe(o),this.plugin.register(()=>d.disconnect())}};var bt=class{constructor(o){this.plugin=o;this.popup=null;this.icon=null;this.highlightMode=!1;this.startInfo=null;document.addEventListener("click",this.onClick.bind(this)),document.addEventListener("keydown",i=>i.key==="Escape"&&this.cancelMode()),this.plugin.register(()=>{document.removeEventListener("click",this.onClick.bind(this)),document.removeEventListener("keydown",this.cancelMode)}),this.plugin.app.workspace.on("layout-change",()=>this.applyAllRangeHighlights()),this.plugin.register(()=>this.plugin.app.workspace.off("layout-change",this.applyAllRangeHighlights.bind(this))),setTimeout(()=>this.applyAllRangeHighlights(),1e3)}async refresh(){this.applyAllRangeHighlights()}cancelMode(){this.highlightMode=!1,this.startInfo=null,this.hideIcon(),document.body.style.cursor="default",document.querySelectorAll(".chapter").forEach(o=>o.style.cursor="default")}onClick(o){let i=o.target,a=i.closest(".Word");if(i.classList.contains("range-delete-btn")){o.preventDefault(),o.stopPropagation();let p=i.closest(".range-highlight-overlay"),f=p==null?void 0:p.dataset.key;f&&this.plugin.highlightsData[f]&&(delete this.plugin.highlightsData[f],this.plugin.saveHighlights());return}if(!a){this.hideIcon(),this.highlightMode=!1,document.body.style.cursor="default",document.querySelectorAll(".chapter").forEach(p=>p.style.cursor="default");return}let u=a.closest(".chapter");if(!u)return;let n=u.getAttribute("data-db-file"),d=u.getAttribute("data-table");if(i.classList.contains("highlighter-icon")){o.preventDefault(),o.stopPropagation(),this.startHighlight(a,n,d);return}if(this.highlightMode&&this.startInfo){o.preventDefault(),o.stopPropagation(),this.completeRange(a);return}if(o.shiftKey&&this.startInfo){o.preventDefault(),o.stopPropagation(),this.completeRange(a);return}this.showIcon(a,n,d)}showIcon(o,i,a){this.hideIcon();let u=o.getBoundingClientRect();this.icon=document.body.createDiv({cls:"highlighter-icon",text:"Pencil",attr:{style:`position:absolute;left:${u.right+4+scrollX}px;top:${u.top+scrollY}px;z-index:10000;cursor:pointer;font-size:1.3em;`}}),this.icon.onclick=n=>{n.preventDefault(),n.stopPropagation(),this.startHighlight(o,i,a)}}hideIcon(){var o;(o=this.icon)==null||o.remove(),this.icon=null}startHighlight(o,i,a){this.highlightMode=!0,this.hideIcon(),document.body.style.cursor="default",document.querySelectorAll(".chapter").forEach(w=>w.style.cursor="crosshair"),this.plugin.register(()=>{document.body.style.cursor="default",document.querySelectorAll(".chapter").forEach(w=>w.style.cursor="default")});let u=Number(o.dataset.db),n=this.plugin.db.getDb(i);if(!n)return;let d=n.prepare(`SELECT BookID, Chapter, Verse FROM ${this.plugin.db.escapeTable(a)} WHERE rowid = ?`);if(d.bind([u]),!d.step()){d.free();return}let p=d.getAsObject();d.free();let f=this.plugin.db.getBookName(i,p.BookID);if(!f)return;let m=n.prepare(`SELECT COUNT(*) as cnt FROM ${this.plugin.db.escapeTable(a)} WHERE BookID = ? AND Chapter = ? AND Verse = ? AND rowid < ?`);m.bind([p.BookID,p.Chapter,p.Verse,u]),m.step();let v=m.getAsObject().cnt;m.free(),this.startInfo={dbFile:i,tableName:a,rowid:u,bookId:p.BookID,book:f,chapter:p.Chapter,verse:p.Verse,wordNum:v+1}}completeRange(o){if(!this.startInfo)return;let i=Number(o.dataset.db),a=this.plugin.db.getDb(this.startInfo.dbFile);if(!a)return;let u=a.prepare(`SELECT BookID, Chapter, Verse FROM ${this.plugin.db.escapeTable(this.startInfo.tableName)} WHERE rowid = ?`);if(u.bind([i]),!u.step()){u.free();return}let n=u.getAsObject();u.free();let d=a.prepare(`SELECT COUNT(*) as cnt FROM ${this.plugin.db.escapeTable(this.startInfo.tableName)} WHERE BookID = ? AND Chapter = ? AND Verse = ? AND rowid < ?`);d.bind([n.BookID,n.Chapter,n.Verse,i]),d.step();let p=d.getAsObject().cnt;d.free();let f=this.startInfo.wordNum,m=p+1;m<f&&([f,m]=[m,f]);let v=`${this.startInfo.dbFile}|${this.startInfo.book}|${this.startInfo.chapter}|${this.startInfo.verse}-${n.Verse}|${f}-${m}`;this.currentRange={dbFile:this.startInfo.dbFile,book:this.startInfo.book,chapter:this.startInfo.chapter,verse_start:this.startInfo.verse,verse_end:n.Verse,word_start:f,word_end:m},this.highlightMode=!1,document.querySelectorAll(".chapter").forEach(D=>D.style.cursor="default");let w=o.getBoundingClientRect();this.showPopup(w,v)}showPopup(o,i){this.popup=document.body.createDiv({cls:"mod-popup"}),Object.assign(this.popup.style,{position:"absolute",left:`${o.right+scrollX+8}px`,top:`${o.bottom+scrollY}px`,background:"var(--background-primary)",border:"1px solid var(--background-modifier-border)",padding:"8px",borderRadius:"6px",zIndex:"10000",boxShadow:"0 4px 12px rgba(0,0,0,0.3)",fontSize:"0.9em"});let a=this.popup.createEl("select");[{v:"none",t:"None"},{v:"highlight1",t:"Highlight 1"},{v:"highlight2",t:"Highlight 2"},{v:"highlight3",t:"Highlight 3"},{v:"highlight4",t:"Highlight 4"},{v:"highlight5",t:"Highlight 5"},{v:"highlight6",t:"Highlight 6"},{v:"highlight7",t:"Highlight 7"},{v:"delight",t:"Delight (low contrast)"}].forEach(d=>{var f;let p=a.createEl("option",{text:d.t,value:d.v});((f=this.plugin.highlightsData[i])==null?void 0:f.type)===d.v&&(p.selected=!0)}),a.onchange=async()=>{var p;let d=a.value;d==="none"?delete this.plugin.highlightsData[i]:this.plugin.highlightsData[i]={resource:this.currentRange.dbFile,book:this.currentRange.book,chapter:this.currentRange.chapter,verse_start:this.currentRange.verse_start,verse_end:this.currentRange.verse_end,word_start:this.currentRange.word_start,word_end:this.currentRange.word_end,type:d},await this.plugin.saveHighlights(),(p=this.popup)==null||p.remove(),this.currentRange=null,this.refresh()},this.popup.onmousedown=d=>d.stopPropagation();let n=d=>{var p,f;return!((p=this.popup)!=null&&p.contains(d.target))&&((f=this.popup)==null||f.remove(),document.removeEventListener("mousedown",n))};setTimeout(()=>document.addEventListener("mousedown",n),0)}applyAllRangeHighlights(){document.querySelectorAll(".range-highlight-overlay").forEach(o=>o.remove());for(let o in this.plugin.highlightsData){let i=this.plugin.highlightsData[o];document.querySelectorAll(".chapter").forEach(a=>{if(a.getAttribute("data-db-file")!==i.resource)return;let u=this.plugin.db.getDb(i.resource);if(!u)return;let n=this.plugin.db.getBookId(i.resource,i.book);if(n===null)return;let d=a.getAttribute("data-table"),p=u.prepare(`
          SELECT rowid, Verse FROM ${this.plugin.db.escapeTable(d)}
          WHERE BookID = ? AND Chapter = ? AND Verse BETWEEN ? AND ?
          ORDER BY Verse, rowid
        `);p.bind([n,i.chapter,i.verse_start,i.verse_end]);let f=[],m=i.verse_start,v=1;for(;p.step();){let w=p.getAsObject(),D=w.Verse;if(D!==m&&(v=1,m=D),D===i.verse_start&&v>=i.word_start||D===i.verse_end&&v<=i.word_end||D>i.verse_start&&D<i.verse_end){let E=a.querySelector(`.Word[data-db="${w.rowid}"]`);E&&f.push(E)}v++}p.free(),f.length>0&&this.createLineByLineOverlays(a,f,i.type,o)})}}createLineByLineOverlays(o,i,a,u){if(i.length===0)return;let n=i.slice().sort((y,C)=>Number(y.dataset.db)-Number(C.dataset.db)),p=Array.from(o.querySelectorAll(".Word")).slice().sort((y,C)=>Number(y.dataset.db)-Number(C.dataset.db)),f=Number(n[0].dataset.db),m=Number(n[n.length-1].dataset.db),v=p.findIndex(y=>Number(y.dataset.db)===f),w=p.findIndex(y=>Number(y.dataset.db)===m);if(v===-1||w===-1)return;let D=[],_=[],E=-1/0;for(let y=0;y<p.length;y++){let C=p[y],B=C.getBoundingClientRect().top;Math.abs(B-E)>5&&_.length>0&&(D.push(_),_=[]),_.push(C),E=B,y===p.length-1&&_.length>0&&D.push(_)}let S=[],H=!1;for(let y of D){let C=y.some(k=>Number(k.dataset.db)===f),R=y.some(k=>Number(k.dataset.db)===m),B=y.some(k=>{let x=Number(k.dataset.db);return x>=f&&x<=m});if(C&&(H=!0),(H||B)&&S.push(y),R)break}S.forEach((y,C)=>{let R=o.createDiv({cls:`range-highlight-overlay ${a==="delight"?"delight":a.replace(/(\d)/,"-$1")}`,attr:{"data-key":u}});C===0&&R.createEl("div",{cls:"range-delete-btn",text:"X",attr:{style:"position:absolute;right:4px;top:4px;font-size:0.8em;cursor:pointer;z-index:10;background:rgba(0,0,0,0.4);color:white;width:16px;height:16px;border-radius:50%;text-align:center;line-height:16px;"}}),o.style.position="relative";let B=()=>{let x=o.getBoundingClientRect(),M=1/0,Z=-1/0,$=1/0,I=-1/0;y.forEach(ee=>{let V=ee.getBoundingClientRect();M=Math.min(M,V.left-x.left),Z=Math.max(Z,V.right-x.left),$=Math.min($,V.top-x.top),I=Math.max(I,V.bottom-x.top)});let le=C===0,F=C===S.length-1,G=o.offsetWidth;S.length===1||(le&&(Z=G),F&&(M=0),!le&&!F&&(M=0,Z=G)),R.style.cssText=`
        position: absolute;
        left: ${M}px;
        top: ${$}px;
        width: ${Z-M}px;
        height: ${I-$}px;
        pointer-events: none;
        border-radius: 4px;
        z-index: 1;
      `};B();let k=new ResizeObserver(B);k.observe(o),y.forEach(x=>k.observe(x)),this.plugin.register(()=>k.disconnect())})}};var kr={enableMacrons:!0,enableNiqqud:!0,enableVerseNumbers:!0,referenceFormatBelow:!0,defaultOtVersions:["KJVA","ASV","BSB"],defaultNtVersions:["KJVA","ASV","BSB"],wordHoverColorLight:"#d35400",wordHoverColorDark:"#f39c12"};var wt=class extends ae.Plugin{constructor(){super(...arguments);this.settings=kr;this.styleEl=null;this.difficultyData={};this.highlightsData={}}async onload(){console.log("Starting onload()..."),await this.loadSettings(),this.db=new dt(this.app,this.manifest.id),await this.db.init(),this.tooltip=new ut(this.app,this,this.db,this.settings),this.tooltip.register(),this.renderer=new Oe(this.db),this.resource=new ot(this.db,this.renderer),this.seraph=new ft(this.app,this.db,this.settings),this.seraph.register(this),await this.loadDifficulty(),await this.tooltip.loadStatuses(this.difficultyData),this.highlightManager=new mt(this),this.rangeHighlightManager=new bt(this),setTimeout(()=>this.highlightManager.refresh(),1500),await this.loadHighlights(),this.addCommand({id:"generate-bib-resources",name:"Generate BibResources (First 2 Chapters)",callback:()=>{this.resource.generate()}}),this.addCommand({id:"generate-chapter",name:"Generate chapter",callback:async()=>{try{let i=await this.promptReferenceAndResource();if(!i)return;let{reference:a,selectedTable:u}=i;await this.resource.generateChapter(a,u)}catch(i){new ae.Notice(`Error generating chapter: ${i.message}`)}}}),this.addSettingTab(new Bt(this.app,this)),this.applyLiveCss(),this.registerEvent(this.app.workspace.on("layout-change",()=>this.updateCss()))}getHighlightsPath(){return this.manifest.dir+"/highlights.json"}async loadHighlights(){let i=this.getHighlightsPath();try{if(await this.app.vault.adapter.exists(i)){let a=await this.app.vault.adapter.read(i);this.highlightsData=JSON.parse(a),console.log("Loaded highlights.json")}else this.highlightsData={}}catch(a){console.error("Error loading highlights.json:",a),this.highlightsData={}}}async saveHighlights(){let i=`${this.manifest.dir}/highlights.json`;await this.app.vault.adapter.write(i,JSON.stringify(this.highlightsData||{},null,2)),await this.rangeHighlightManager.refresh()}async refreshHighlights(){await this.highlightManager.refresh()}buildLiveCss(){let i=[];return i.push(`.chapter { --show-mac: ${this.settings.enableMacrons?1:0}; --show-niq: ${this.settings.enableNiqqud?1:0}; }`),i.push(`.chapter .Mac { display: ${this.settings.enableMacrons?"inline":"none"}; }`),i.push(`.chapter .noMac { display: ${this.settings.enableMacrons?"none":"inline"}; }`),i.push(`.chapter .N { display: ${this.settings.enableNiqqud?"inline":"none"}; }`),i.push(`.chapter .nN { display: ${this.settings.enableNiqqud?"none":"inline"}; }`),i.push(`.chapter .verseM { display: ${this.settings.enableVerseNumbers?"inline":"none"}; }`),i.push('[lang="he"] { direction: rtl; text-align: right; }'),i.push('[lang="el"], [lang="en"] { direction: ltr; text-align: left; }'),i.push(".Word { cursor: help; }"),i.push(".Word::after { content: none !important; }"),i.push(".Word:hover::after { display: none !important; }"),i.join(`
`)}updateCss(){let i=this.settings.enableMacrons?"1":"0",a=this.settings.enableNiqqud?"1":"0",u=this.settings.enableVerseNumbers?"1":"0",n=this.settings.referenceFormatBelow?"below":"above";document.querySelectorAll(".chapter").forEach(d=>{d.setAttribute("data-show-mac",i),d.setAttribute("data-show-niq",a),d.setAttribute("data-show-verse",u)}),document.querySelectorAll(".seraph-overall-container").forEach(d=>{d.setAttribute("data-ref-pos",n)}),this.app.workspace.getLeavesOfType("markdown").forEach(d=>{d.view instanceof ae.MarkdownView&&d.view.getMode()==="preview"&&d.view.previewMode.rerender(!0)})}applyLiveCss(){this.styleEl&&this.styleEl.remove(),this.styleEl=document.createElement("style"),this.styleEl.textContent=this.buildLiveCss(),document.head.appendChild(this.styleEl),this.register(()=>{var i;return(i=this.styleEl)==null?void 0:i.remove()})}async loadSettings(){this.settings=Object.assign({},kr,await this.loadData()),this.updateCss()}async saveSettings(){await this.saveData(this.settings),this.applyLiveCss(),this.updateCss(),this.tooltip.updateSettings(this.settings)}getDifficultyPath(){return this.manifest.dir+"/difficulty.json"}async loadDifficulty(){let i=this.getDifficultyPath();try{if(await this.app.vault.adapter.exists(i)){let a=await this.app.vault.adapter.read(i);this.difficultyData=JSON.parse(a),console.log("Loaded difficulty.json from plugin data folder")}else this.difficultyData={},console.log("No difficulty.json found in plugin data folder \u2013 starting fresh")}catch(a){console.error("Error loading difficulty.json:",a),this.difficultyData={}}}async saveDifficulty(){let i=JSON.stringify(this.difficultyData,null,2),a=this.getDifficultyPath();try{await this.app.vault.adapter.write(a,i),console.log("Saved difficulty.json to plugin data folder")}catch(u){console.error("Error saving difficulty.json:",u)}}onunload(){this.db.unload(),this.tooltip.unregister()}async promptReferenceAndResource(){return new Promise(i=>{let a=new class extends ae.Modal{constructor(){super(...arguments);this.selectedIdx=null;this.onSubmit=n=>{n.preventDefault();let p=this.contentEl.querySelector("input").value.trim();if(!p||this.selectedIdx===null){new ae.Notice("Please enter a reference and select a resource");return}let m=this.app.plugin.db.getTables()[this.selectedIdx];this.close(),i({reference:p,selectedTable:m})}}onOpen(){let{contentEl:n}=this,d=this.app.plugin.db.getTables();n.createEl("h3",{text:"Generate Bible Chapter"}),n.createEl("p",{text:"Enter reference (e.g., Genesis 1, John 3, Ps 23)"});let p=n.createEl("input",{type:"text",placeholder:"Book Chapter",cls:"u-popout-input"});p.style.width="100%",p.style.marginBottom="1em",n.createEl("p",{text:"Select resource:"});let f=n.createEl("select",{cls:"u-popout-input"});f.style.width="100%",f.style.marginBottom="1em",d.map(w=>({label:`${w.dbFile.replace(".db","")} to ${w.tableName}`,value:w})).forEach((w,D)=>{let _=f.createEl("option",{text:w.label,value:D.toString()});D===0&&(_.selected=!0)}),f.onchange=()=>{this.selectedIdx=parseInt(f.value,10)},this.selectedIdx=0;let v=n.createEl("button",{text:"Generate",cls:"mod-cta"});v.onclick=this.onSubmit,p.focus(),p.addEventListener("keydown",w=>{w.key==="Enter"&&this.onSubmit(w)})}onClose(){var n;(!((n=this.contentEl.querySelector("input"))!=null&&n.value)||this.selectedIdx===null)&&i(null)}}(this.app);a.app.plugin=this,a.open()})}},Le=class Le extends ae.PluginSettingTab{static formatList(o){return o.length<5?o.join(", "):o.slice(0,4).join(", ")+`, ... (total: ${o.length})`}constructor(o,i){super(o,i),this.plugin=i}display(){let{containerEl:o}=this;o.empty(),o.createEl("h2",{text:"Seraph Plugin Settings"}),o.createEl("h3",{text:"Default Resources for Seraph Blocks"}),new ae.Setting(o).setName("Default Old Testament for Seraph Blocks").setDesc(`A comma-separated list of version abbreviations (e.g., KJVA, ASV, LXX) for Old Testament passages. The order you list them in is the order they will be displayed. Available versions include: ${Le.formatList(Le.OT_VERSIONS)}. (Excludes GNT-only resources.)`).setClass("seraph-setting-textarea").addTextArea(i=>{i.setValue(this.plugin.settings.defaultOtVersions.join(", ")).setPlaceholder(this.plugin.settings.defaultOtVersions.join(", ")).onChange(async a=>{this.plugin.settings.defaultOtVersions=a.split(",").map(u=>u.trim()).filter(u=>u.length>0),await this.plugin.saveSettings()})}),new ae.Setting(o).setName("Default New Testament for Seraph Blocks").setDesc(`A comma-separated list of version abbreviations (e.g., SBLGNT, KJVA, ASV) for New Testament passages. The order you list them in is the order they will be displayed. Available versions include: ${Le.formatList(Le.NT_VERSIONS)}. (Excludes Hebrew OT-only resource.)`).setClass("seraph-setting-textarea").addTextArea(i=>{i.setValue(this.plugin.settings.defaultNtVersions.join(", ")).setPlaceholder(this.plugin.settings.defaultNtVersions.join(", ")).onChange(async a=>{this.plugin.settings.defaultNtVersions=a.split(",").map(u=>u.trim()).filter(u=>u.length>0),await this.plugin.saveSettings()})}),o.createEl("h3",{text:"Appearance Settings"}),new ae.Setting(o).setName("Enable Macrons (Greek)").setDesc("Show macronized text in Greek resources").addToggle(i=>i.setValue(this.plugin.settings.enableMacrons).onChange(async a=>{this.plugin.settings.enableMacrons=a,await this.plugin.saveSettings()})),new ae.Setting(o).setName("Enable Niqqud (Hebrew)").setDesc("Show niqqud in Hebrew resources").addToggle(i=>i.setValue(this.plugin.settings.enableNiqqud).onChange(async a=>{this.plugin.settings.enableNiqqud=a,await this.plugin.saveSettings()})),new ae.Setting(o).setName("Enable Verse Numbers").setDesc("Show verse numbers in resources").addToggle(i=>i.setValue(this.plugin.settings.enableVerseNumbers).onChange(async a=>{this.plugin.settings.enableVerseNumbers=a,await this.plugin.saveSettings()})),new ae.Setting(o).setName("Reference Position").setDesc("Toggle between displaying the reference as a clickable header above the text (default) or as a clickable footnote below the text.").addToggle(i=>i.setValue(this.plugin.settings.referenceFormatBelow).onChange(async a=>{this.plugin.settings.referenceFormatBelow=a,await this.plugin.saveSettings(),new ae.Notice("Reference format changed. Please reload notes to see changes.")})),new ae.Setting(o).setName("Word Hover Color (Light Mode)").setDesc("Color of the word when hovered in Light Mode.").addColorPicker(i=>i.setValue(this.plugin.settings.wordHoverColorLight).onChange(async a=>{this.plugin.settings.wordHoverColorLight=a,await this.plugin.saveSettings()})),new ae.Setting(o).setName("Word Hover Color (Dark Mode)").setDesc("Color of the word when hovered in Dark Mode.").addColorPicker(i=>i.setValue(this.plugin.settings.wordHoverColorDark).onChange(async a=>{this.plugin.settings.wordHoverColorDark=a,await this.plugin.saveSettings()}))}};Le.OT_VERSIONS=["ASV","BSB","KJVA","LEB","NET","NWT","YLT","NASB","LXX","Hebrew"],Le.NT_VERSIONS=["ASV","BSB","KJVA","LEB","NET","NWT","YLT","NASB","LXX","SBLGNT-B","WH","Tisch","TR","WWH","NA1904","SBLGNT","TNT"];var Bt=Le;
